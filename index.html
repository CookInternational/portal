<!-- Cook International Casino — Admin Portal (Front-End v5.0) -->
<div id="cookintl-admin">

  <style>
    /* Root scope */
    #cookintl-admin {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #f9fafb;
    }

    #cookintl-admin a {
      color: #e5e7eb;
      text-decoration: none;
    }

    #cookintl-admin a:hover {
      text-decoration: underline;
    }

    .ci-admin-shell {
      max-width: 1240px;
      margin: 0 auto;
      padding: 20px 16px 32px;
    }

    /* Login */
    .ci-admin-login {
      max-width: 420px;
      margin: 32px auto;
      padding: 24px 20px 20px;
      background: radial-gradient(circle at top, rgba(148, 163, 253, 0.45), rgba(15, 23, 42, 0.95));
      border-radius: 24px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 253, 0.4);
    }

    .ci-admin-login h2 {
      font-size: 20px;
      margin: 0 0 4px;
    }

    .ci-admin-login p {
      margin: 0 0 16px;
      font-size: 13px;
      color: #d1d5db;
    }

    .ci-field {
      margin-bottom: 12px;
    }

    .ci-label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .ci-input {
      width: 100%;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid rgba(148, 163, 253, 0.6);
      background: rgba(15, 23, 42, 0.8);
      color: #f9fafb;
      outline: none;
    }

    .ci-input:focus {
      border-color: #a5b4fc;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.35);
    }

    .ci-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      border: 0;
      cursor: pointer;
      background: linear-gradient(135deg, #4f46e5, #a855f7);
      color: #f9fafb;
      font-weight: 500;
      box-shadow: 0 12px 30px rgba(79, 70, 229, 0.45);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
    }

    .ci-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(79, 70, 229, 0.6);
      opacity: 0.95;
    }

    .ci-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .ci-btn-secondary {
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 253, 0.5);
      box-shadow: none;
    }

    .ci-login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #fecaca;
      min-height: 14px;
    }

    /* Header */
    .ci-admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 14px;
    }

    .ci-admin-title-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ci-admin-logo {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #f97316, #111827);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #fef3c7;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.85);
    }

    .ci-admin-title-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ci-admin-title-text h1 {
      font-size: 18px;
      margin: 0;
    }

    .ci-admin-title-text span {
      font-size: 12px;
      color: #9ca3af;
    }

    .ci-admin-user {
      font-size: 12px;
      color: #d1d5db;
      text-align: right;
    }

    .ci-admin-user strong {
      font-weight: 600;
      color: #e5e7eb;
    }

    /* Tabs */
    .ci-admin-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 14px;
    }

    .ci-admin-tab {
      border-radius: 999px;
      padding: 6px 10px;
      border: 0;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .ci-admin-tab span {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .ci-admin-tab strong {
      font-size: 12px;
    }

    .ci-admin-tab.is-active {
      background: radial-gradient(circle at top, rgba(79, 70, 229, 0.8), rgba(15, 23, 42, 0.95));
      border-color: rgba(129, 140, 248, 0.7);
      box-shadow: 0 10px 30px rgba(55, 48, 163, 0.7);
    }

    /* Panels */
    .ci-admin-main {
      border-radius: 30px;
      padding: 20px 18px 18px;
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.65), rgba(15, 23, 42, 0.98));
      box-shadow: 0 26px 60px rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 253, 0.55);
      min-height: 280px;
    }

    .ci-admin-panel {
      display: none;
    }

    .ci-admin-panel.is-active {
      display: block;
    }

    /* Cards / Layout */
    .ci-dashboard-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .ci-dashboard-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .ci-admin-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .ci-admin-user {
        text-align: left;
      }
    }

    .ci-card {
      border-radius: 22px;
      padding: 14px 14px 12px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(75, 85, 99, 0.9);
    }

    .ci-card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .ci-card-title {
      font-size: 13px;
      font-weight: 600;
    }

    .ci-card-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .ci-small-note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .ci-chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 253, 0.6);
      color: #e5e7eb;
    }

    .ci-chip-muted {
      background: rgba(31, 41, 55, 0.9);
      border-color: rgba(75, 85, 99, 0.9);
    }

    /* Table */
    .ci-table-wrap {
      max-height: 340px;
      overflow: auto;
      border-radius: 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    table.ci-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    table.ci-table thead {
      background: rgba(15, 23, 42, 0.96);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    table.ci-table th,
    table.ci-table td {
      padding: 6px 8px;
      white-space: nowrap;
      text-align: left;
    }

    table.ci-table th {
      font-weight: 500;
      color: #9ca3af;
      cursor: pointer;
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
    }

    table.ci-table td {
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    table.ci-table tr:nth-child(even) td {
      background: rgba(17, 24, 39, 0.85);
    }

    table.ci-table tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.95);
    }

    table.ci-table tr:hover td {
      background: rgba(30, 64, 175, 0.5);
    }

    .ci-th-sort {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .ci-sort-indicator {
      font-size: 10px;
      opacity: 0.6;
    }

    /* Grid toolbar */
    .ci-grid-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .ci-grid-toolbar-left,
    .ci-grid-toolbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .ci-grid-search {
      min-width: 180px;
    }

    .ci-select {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 11px;
    }

    .ci-pill-btn {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
    }

    .ci-pill-btn:hover {
      border-color: rgba(129, 140, 248, 0.7);
    }

    /* Status select */
    .ci-status-select {
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(17, 24, 39, 0.95);
      color: #e5e7eb;
      font-size: 11px;
    }

    /* Split layout (Players) */
    .ci-split {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.1fr);
      gap: 14px;
    }

    @media (max-width: 980px) {
      .ci-split {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .ci-side-panel {
      border-radius: 22px;
      padding: 12px 12px 10px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(75, 85, 99, 0.9);
      max-height: 370px;
      overflow: auto;
    }

    .ci-side-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .ci-side-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ci-side-title {
      font-size: 13px;
      font-weight: 600;
    }

    .ci-side-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .ci-side-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }

    .ci-side-pill {
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
    }

    .ci-side-pill:hover {
      border-color: rgba(129, 140, 248, 0.7);
    }

    .ci-side-section {
      margin-bottom: 8px;
    }

    .ci-side-section h4 {
      margin: 0 0 4px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .ci-side-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 4px 8px;
      font-size: 11px;
    }

    @media (max-width: 600px) {
      .ci-side-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .ci-side-field-label {
      color: #9ca3af;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .ci-side-field-value {
      font-size: 11px;
    }

    .ci-side-full-record {
      font-size: 11px;
      border-top: 1px dashed rgba(55, 65, 81, 0.9);
      padding-top: 6px;
      margin-top: 4px;
    }

    .ci-side-full-record-row {
      display: grid;
      grid-template-columns: 120px minmax(0, 1fr);
      gap: 4px;
      margin-bottom: 3px;
    }

    .ci-side-full-record-label {
      color: #9ca3af;
      font-size: 10px;
    }

    .ci-side-full-record-value {
      font-size: 11px;
      color: #e5e7eb;
      overflow-wrap: anywhere;
    }

    /* Dashboard cashouts widget */
    .ci-dash-cashouts-table {
      max-height: 230px;
      overflow: auto;
      border-radius: 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      margin-top: 4px;
    }

    .ci-dash-cashouts-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .ci-dash-cashouts-table th,
    .ci-dash-cashouts-table td {
      padding: 5px 7px;
      white-space: nowrap;
      text-align: left;
    }

    .ci-dash-cashouts-table thead {
      background: rgba(15, 23, 42, 0.96);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .ci-dash-cashouts-table tr:nth-child(even) td {
      background: rgba(17, 24, 39, 0.96);
    }

    .ci-dash-cashouts-table tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.96);
    }

    /* Reports Graph */
    .ci-reports-view-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      overflow: hidden;
    }

    .ci-reports-view-btn {
      padding: 4px 10px;
      font-size: 11px;
      background: transparent;
      border: none;
      color: #e5e7eb;
      cursor: pointer;
    }

    .ci-reports-view-btn.is-active {
      background: rgba(55, 65, 81, 0.9);
    }

    .ci-reports-graph {
      margin-top: 8px;
      max-height: 340px;
      overflow: auto;
      border-radius: 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 10px;
      font-size: 11px;
    }

    .ci-kpi-row {
      margin-bottom: 10px;
    }

    .ci-kpi-label {
      font-size: 11px;
      color: #d1d5db;
      margin-bottom: 2px;
    }

    .ci-kpi-bars {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .ci-kpi-bar {
      height: 8px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.8);
      flex-shrink: 0;
    }

    .ci-kpi-bar-secondary {
      background: rgba(244, 114, 182, 0.8);
    }

    .ci-kpi-bar-tertiary {
      background: rgba(52, 211, 153, 0.85);
    }

    .ci-kpi-legend {
      display: flex;
      gap: 6px;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    .ci-kpi-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 4px;
    }

    .ci-kpi-dot-primary {
      background: rgba(59, 130, 246, 0.9);
    }

    .ci-kpi-dot-secondary {
      background: rgba(244, 114, 182, 0.9);
    }

    .ci-kpi-dot-tertiary {
      background: rgba(52, 211, 153, 0.95);
    }

    /* Misc */
    .ci-muted {
      color: #9ca3af;
    }

    .ci-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(37, 99, 235, 0.3);
      border: 1px solid rgba(59, 130, 246, 0.7);
      color: #dbeafe;
    }
  </style>

  <!-- Login -->
  <div class="ci-admin-login" id="ci-admin-login">
    <h2>Cook International Casino</h2>
    <p>Owner / Risk Admin portal login.</p>

    <form id="ci-login-form">
      <div class="ci-field">
        <label class="ci-label" for="ci-login-user">Admin Email</label>
        <input id="ci-login-user" class="ci-input" type="email" autocomplete="username" required />
      </div>
      <div class="ci-field">
        <label class="ci-label" for="ci-login-pass">Password</label>
        <input id="ci-login-pass" class="ci-input" type="password" autocomplete="current-password" required />
      </div>
      <button type="submit" class="ci-btn" id="ci-login-submit">Sign In</button>
      <div class="ci-login-error" id="ci-login-error"></div>
      <div class="ci-small-note">
        Internal access only. All actions logged to Admin Log & global Log.
      </div>
    </form>
  </div>

  <!-- Main Shell -->
  <div class="ci-admin-shell" id="ci-admin-shell" style="display:none;">

    <header class="ci-admin-header">
      <div class="ci-admin-title-block">
        <div class="ci-admin-logo">C</div>
        <div class="ci-admin-title-text">
          <h1>Cook International Casino — Admin Portal</h1>
          <span>Blackjack · Slots · Table Games · Risk & Compliance</span>
        </div>
      </div>
      <div class="ci-admin-user">
        Signed in as<br />
        <strong id="ci-admin-user-label">Owner</strong>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="ci-admin-tabs" id="ci-admin-tabs">
      <button type="button" class="ci-admin-tab is-active" data-tab="dashboard">
        <span>HOME</span><strong>Dashboard</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="players">
        <span>PLAYERS</span><strong>Accounts</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="cashouts">
        <span>PAYOUT</span><strong>Cashouts</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="rewards">
        <span>LOYALTY</span><strong>Rewards</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="gameLedger">
        <span>TABLES</span><strong>Game Ledger</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="log">
        <span>AUDIT</span><strong>Log</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="reports">
        <span>HOUSE</span><strong>Reports</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="stripe">
        <span>CARDS</span><strong>Stripe</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="paypal">
        <span>WALLETS</span><strong>PayPal</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="blacklist">
        <span>BLACKLIST</span><strong>Risk</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="adminlog">
        <span>SYS</span><strong>Admin Log</strong>
      </button>
      <button type="button" class="ci-admin-tab" data-tab="settings">
        <span>SYSTEM</span><strong>Settings</strong>
      </button>
    </nav>

    <!-- Main Content -->
    <main class="ci-admin-main">

      <!-- DASHBOARD -->
      <section class="ci-admin-panel is-active" data-tab-panel="dashboard">
        <div class="ci-dashboard-grid">
          <div class="ci-card">
            <div class="ci-card-header">
              <div>
                <div class="ci-card-title">Overview</div>
                <div class="ci-card-sub">
                  House snapshot, active players, and chips in play.
                </div>
              </div>
              <button type="button" class="ci-pill-btn" data-dashboard-refresh>
                Refresh
              </button>
            </div>

            <!-- Simple high-level KPIs (data fed from Reports if available) -->
            <div id="ci-dashboard-kpis" class="ci-side-grid" style="margin-bottom:8px;">
              <!-- Filled via JS from Reports / backend -->
            </div>

            <div class="ci-small-note">
              Aggregates are driven by the <span class="ci-badge">Reports</span> tab snapshot
              and live ledger activity.
            </div>
          </div>

          <div class="ci-card">
            <div class="ci-card-header">
              <div>
                <div class="ci-card-title">Recent Cashout Requests</div>
                <div class="ci-card-sub">
                  Uses <strong>Requested At</strong> (Column A) and <strong>USD Equivalent</strong> (Column G).
                </div>
              </div>
              <span class="ci-chip ci-chip-muted">Last 5</span>
            </div>
            <div data-dashboard-cashouts class="ci-dash-cashouts-table">
              Loading recent cashouts...
            </div>
            <div class="ci-small-note">
              Status & payout method are editable on the full Cashouts tab.
            </div>
          </div>
        </div>
      </section>

      <!-- PLAYERS -->
      <section class="ci-admin-panel" data-tab-panel="players">
        <div class="ci-split">
          <!-- Left: Players Grid -->
          <div>
            <div class="ci-grid-toolbar">
              <div class="ci-grid-toolbar-left">
                <span class="ci-card-sub">Players Sheet</span>
              </div>
              <div class="ci-grid-toolbar-right">
                <input
                  type="search"
                  class="ci-input ci-grid-search"
                  placeholder="Search (Player ID, Username, Email, Name...)"
                  data-grid-search="players"
                />
                <button type="button" class="ci-pill-btn" data-grid-reload="players">
                  Reload
                </button>
              </div>
            </div>
            <div class="ci-table-wrap" data-grid-table="players">
              <!-- table injected by JS -->
            </div>
          </div>

          <!-- Right: Player Detail -->
          <aside class="ci-side-panel" data-player-detail>
            <div class="ci-side-header">
              <div class="ci-side-title-block">
                <div class="ci-side-title">Player Details</div>
                <div class="ci-side-sub">
                  Select a player row to view full record and drilldowns.
                </div>
              </div>
            </div>
            <div class="ci-small-note">
              Player-centric drilldowns will search <strong>Log</strong>, <strong>Game Ledger</strong>,
              <strong>Rewards</strong>, and <strong>Cashouts</strong> using the Player ID.
            </div>
          </aside>
        </div>
      </section>

      <!-- CASHOUTS -->
      <section class="ci-admin-panel" data-tab-panel="cashouts">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">Cashouts — Column A = Requested At, Column G = USD Equivalent.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <input
              type="search"
              class="ci-input ci-grid-search"
              placeholder="Search (Player ID, Username, Email, Status...)"
              data-grid-search="cashouts"
            />
            <button type="button" class="ci-pill-btn" data-grid-reload="cashouts">
              Reload
            </button>
          </div>
        </div>
        <div class="ci-table-wrap" data-grid-table="cashouts">
          <!-- JS -->
        </div>
        <div class="ci-small-note">
          <strong>Status</strong> column is editable (Pending / Review / Approved / Rejected).
          Requires backend <code>updateCell</code> + <code>rowNumbers</code> support.
        </div>
      </section>

      <!-- REWARDS -->
      <section class="ci-admin-panel" data-tab-panel="rewards">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">Rewards redemptions & loyalty.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <input
              type="search"
              class="ci-input ci-grid-search"
              placeholder="Search (Player ID, Reward Type, Status...)"
              data-grid-search="rewards"
            />
            <button type="button" class="ci-pill-btn" data-grid-reload="rewards">
              Reload
            </button>
          </div>
        </div>
        <div class="ci-table-wrap" data-grid-table="rewards">
          <!-- JS -->
        </div>
        <div class="ci-small-note">
          <strong>Status</strong> is editable here as well (same <code>updateCell</code> pattern).
        </div>
      </section>

      <!-- GAME LEDGER -->
      <section class="ci-admin-panel" data-tab-panel="gameLedger">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">Game Ledger — table rounds, wheels, races.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <input
              type="search"
              class="ci-input ci-grid-search"
              placeholder="Search (Player ID, Game, Round ID...)"
              data-grid-search="gameLedger"
            />
            <button type="button" class="ci-pill-btn" data-grid-reload="gameLedger">
              Reload
            </button>
          </div>
        </div>
        <div class="ci-table-wrap" data-grid-table="gameLedger">
          <!-- JS -->
        </div>
      </section>

      <!-- LOG -->
      <section class="ci-admin-panel" data-tab-panel="log">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">Global Log — security, login, chip events.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <input
              type="search"
              class="ci-input ci-grid-search"
              placeholder="Search (Player ID, Event, IP...)"
              data-grid-search="log"
            />
            <button type="button" class="ci-pill-btn" data-grid-reload="log">
              Reload
            </button>
          </div>
        </div>
        <div class="ci-table-wrap" data-grid-table="log">
          <!-- JS -->
        </div>
      </section>

      <!-- REPORTS -->
      <section class="ci-admin-panel" data-tab-panel="reports">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">House reports — daily net, chips in play, player activity.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <div class="ci-reports-view-toggle">
              <button type="button" class="ci-reports-view-btn is-active" data-reports-view="table">
                Table
              </button>
              <button type="button" class="ci-reports-view-btn" data-reports-view="graph">
                Graph
              </button>
            </div>
            <button type="button" class="ci-pill-btn" data-reports-refresh>
              Rebuild Reports
            </button>
          </div>
        </div>

        <div class="ci-table-wrap" data-grid-table="reports">
          <!-- Table view -->
        </div>

        <div class="ci-reports-graph" data-reports-graph style="display:none;">
          <!-- Graph view -->
        </div>

        <div class="ci-small-note">
          Graph view renders relative bars for <strong>Total Purchased</strong>,
          <strong>Total Cashed Out</strong>, <strong>House Net Win</strong>, and
          <strong>Active Players</strong> using the most recent rows.
        </div>
      </section>

      <!-- STRIPE -->
      <section class="ci-admin-panel" data-tab-panel="stripe">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">Stripe Ledger — card deposits.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <input
              type="search"
              class="ci-input ci-grid-search"
              placeholder="Search (Player ID, Email, Charge ID...)"
              data-grid-search="stripe"
            />
            <button type="button" class="ci-pill-btn" data-grid-reload="stripe">
              Reload
            </button>
          </div>
        </div>
        <div class="ci-table-wrap" data-grid-table="stripe">
          <!-- JS -->
        </div>
      </section>

      <!-- PAYPAL -->
      <section class="ci-admin-panel" data-tab-panel="paypal">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">PayPal Ledger — PayPal deposits.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <input
              type="search"
              class="ci-input ci-grid-search"
              placeholder="Search (Player ID, Email, Tx ID...)"
              data-grid-search="paypal"
            />
            <button type="button" class="ci-pill-btn" data-grid-reload="paypal">
              Reload
            </button>
          </div>
        </div>
        <div class="ci-table-wrap" data-grid-table="paypal">
          <!-- JS -->
        </div>
      </section>

      <!-- BLACKLIST -->
      <section class="ci-admin-panel" data-tab-panel="blacklist">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">Blacklist Risk — excluded and barred accounts.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <input
              type="search"
              class="ci-input ci-grid-search"
              placeholder="Search (Player ID, Username, Name, Notes...)"
              data-grid-search="blacklist"
            />
            <button type="button" class="ci-pill-btn" data-grid-reload="blacklist">
              Reload
            </button>
          </div>
        </div>
        <div class="ci-table-wrap" data-grid-table="blacklist">
          <!-- JS -->
        </div>
        <div class="ci-small-note">
          Use <strong>“Add to Blacklist”</strong> from Player Details to append a record here.
          Backend must expose an <code>addToBlacklist</code> action.
        </div>
      </section>

      <!-- ADMIN LOG -->
      <section class="ci-admin-panel" data-tab-panel="adminlog">
        <div class="ci-grid-toolbar">
          <div class="ci-grid-toolbar-left">
            <span class="ci-card-sub">Admin Log — portal actions and adjustments.</span>
          </div>
          <div class="ci-grid-toolbar-right">
            <input
              type="search"
              class="ci-input ci-grid-search"
              placeholder="Search (Admin, Action, Player ID...)"
              data-grid-search="adminlog"
            />
            <button type="button" class="ci-pill-btn" data-grid-reload="adminlog">
              Reload
            </button>
          </div>
        </div>
        <div class="ci-table-wrap" data-grid-table="adminlog">
          <!-- JS -->
        </div>
      </section>

      <!-- SETTINGS -->
      <section class="ci-admin-panel" data-tab-panel="settings">
        <div class="ci-dashboard-grid">
          <div class="ci-card">
            <div class="ci-card-header">
              <div>
                <div class="ci-card-title">System Email Tests</div>
                <div class="ci-card-sub">
                  Triggers owner / player test emails from the backend.
                </div>
              </div>
            </div>
            <p class="ci-small-note">
              Requires backend actions <code>testOwnerEmail</code> and <code>testPlayerEmail</code> wired to
              send email via your configured Apps Script mailer.
            </p>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
              <button type="button" class="ci-btn-secondary ci-btn" data-test-owner-email>
                Send Test Owner Email
              </button>
              <button type="button" class="ci-btn-secondary ci-btn" data-test-player-email>
                Send Test Player Email
              </button>
            </div>
          </div>

          <div class="ci-card">
            <div class="ci-card-header">
              <div>
                <div class="ci-card-title">Portal Notes</div>
                <div class="ci-card-sub">
                  Front-end only; sheets and backend remain the source of truth.
                </div>
              </div>
            </div>
            <ul style="margin:0 0 6px 16px;font-size:11px;color:#d1d5db;">
              <li>Dashboard cashouts use <strong>Column A: Requested At</strong> and
                <strong>Column G: USD Equivalent</strong>.</li>
              <li>Cashouts & Rewards status editing uses generic <code>updateCell</code> on the underlying sheet.</li>
              <li>Players panel shows the full row from the <strong>Players</strong> sheet (all columns).</li>
              <li>Player drilldowns pre-fill filters on Log, Game Ledger, Rewards, and Cashouts tabs.</li>
            </ul>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    (function () {
      const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzTJ3121csJjqE3pcxYPCKT7tFgzZ68ZLn-ECBFzhrvzfx3EXZw09l3a5ePfSMwMdd2lg/exec"; // <-- backend web app URL
      const root = document.getElementById("cookintl-admin");
      if (!root) return;

      const state = {
        loggedIn: false,
        adminUser: null,
        currentTab: "dashboard",
        grids: {},
        selectedPlayer: null,
      };

      const GRID_CONFIG = {
        players: { sheetName: "Players", limit: 500 },
        cashouts: { sheetName: "Cashouts", limit: 500 },
        rewards: { sheetName: "Rewards", limit: 500 },
        gameLedger: { sheetName: "Game Ledger", limit: 500 },
        log: { sheetName: "Log", limit: 500 },
        reports: { sheetName: "Reports", limit: 500 },
        stripe: { sheetName: "Stripe Ledger", limit: 500 },
        paypal: { sheetName: "PayPal Ledger", limit: 500 },
        blacklist: { sheetName: "Blacklist", limit: 500 },
        adminlog: { sheetName: "Admin Log", limit: 500 },
      };

      function adminPost(action, payload) {
        const body = JSON.stringify({
          action: action,
          adminUser: state.adminUser || "",
          ...(payload || {}),
        });

        return fetch(WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body,
        }).then((r) => r.json());
      }

      function adminGet(action, params) {
        const url = new URL(WEBAPP_URL);
        const sp = url.searchParams;
        sp.set("action", action);
        if (state.adminUser) sp.set("adminUser", state.adminUser);
        if (params) {
          Object.keys(params).forEach((k) => {
            if (params[k] !== undefined && params[k] !== null) {
              sp.set(k, String(params[k]));
            }
          });
        }
        return fetch(url.toString(), { method: "GET" }).then((r) => r.json());
      }

      function init() {
        const loginShell = document.getElementById("ci-admin-login");
        const mainShell = document.getElementById("ci-admin-shell");
        const loginForm = document.getElementById("ci-login-form");
        const loginUser = document.getElementById("ci-login-user");
        const loginPass = document.getElementById("ci-login-pass");
        const loginBtn = document.getElementById("ci-login-submit");
        const loginError = document.getElementById("ci-login-error");
        const adminUserLabel = document.getElementById("ci-admin-user-label");

        const tabs = document.querySelectorAll(".ci-admin-tab");
        const panels = document.querySelectorAll("[data-tab-panel]");

        loginForm.addEventListener("submit", function (ev) {
          ev.preventDefault();
          const user = (loginUser.value || "").trim();
          const pass = (loginPass.value || "").trim();
          if (!user || !pass) return;

          loginError.textContent = "";
          loginBtn.disabled = true;
          loginBtn.textContent = "Signing in...";

          adminPost("admin_login", { username: user, password: pass })
            .then((res) => {
              if (!res || !res.ok) {
                loginError.textContent =
                  (res && res.message) || "Login failed. Check credentials.";
                loginBtn.disabled = false;
                loginBtn.textContent = "Sign In";
                return;
              }
              state.loggedIn = true;
              state.adminUser = res.adminUser || user;

              adminUserLabel.textContent = state.adminUser;
              loginShell.style.display = "none";
              mainShell.style.display = "block";

              setActiveTab("dashboard");
            })
            .catch((err) => {
              console.error(err);
              loginError.textContent = "Unexpected error during login.";
              loginBtn.disabled = false;
              loginBtn.textContent = "Sign In";
            });
        });

        document
          .getElementById("ci-admin-tabs")
          .addEventListener("click", function (ev) {
            const btn = ev.target.closest(".ci-admin-tab");
            if (!btn) return;
            const tab = btn.getAttribute("data-tab");
            if (!tab) return;
            setActiveTab(tab);
          });

        function setActiveTab(tab) {
          state.currentTab = tab;

          tabs.forEach((t) => {
            const isActive = t.getAttribute("data-tab") === tab;
            t.classList.toggle("is-active", isActive);
          });

          panels.forEach((p) => {
            const panelTab = p.getAttribute("data-tab-panel");
            const isActive = panelTab === tab;
            p.classList.toggle("is-active", isActive);
          });

          // Lazy-load data when tab first activated
          if (tab === "dashboard") {
            loadDashboard();
          } else if (GRID_CONFIG[tab]) {
            ensureGridLoaded(tab);
          } else if (tab === "players") {
            ensureGridLoaded("players");
          }
        }

        window.setActiveTab = setActiveTab; // optional debug

        /* Dash refresh */
        document
          .querySelector("[data-dashboard-refresh]")
          .addEventListener("click", function () {
            loadDashboard(true);
          });

        /* Reports view toggle */
        document.addEventListener("click", function (ev) {
          const viewBtn = ev.target.closest("[data-reports-view]");
          if (viewBtn) {
            const view = viewBtn.getAttribute("data-reports-view");
            const all = document.querySelectorAll(".ci-reports-view-btn");
            all.forEach((b) =>
              b.classList.toggle(
                "is-active",
                b.getAttribute("data-reports-view") === view
              )
            );

            const tableWrap = document.querySelector('[data-grid-table="reports"]');
            const graphWrap = document.querySelector("[data-reports-graph]");
            if (view === "graph") {
              if (graphWrap) graphWrap.style.display = "block";
              if (tableWrap) tableWrap.style.display = "none";
              renderReportsGraph();
            } else {
              if (graphWrap) graphWrap.style.display = "none";
              if (tableWrap) tableWrap.style.display = "block";
            }
          }

          const refreshReportsBtn = ev.target.closest("[data-reports-refresh]");
          if (refreshReportsBtn) {
            refreshReportsBtn.disabled = true;
            refreshReportsBtn.textContent = "Rebuilding...";
            adminGet("refreshReports", {})
              .then((res) => {
                if (!res || !res.ok) {
                  alert(
                    (res && res.message) ||
                      "Reports rebuild did not confirm; check backend."
                  );
                }
                ensureGridLoaded("reports", true);
              })
              .catch((err) => {
                console.error(err);
                alert("Error calling refreshReports.");
              })
              .finally(() => {
                refreshReportsBtn.disabled = false;
                refreshReportsBtn.textContent = "Rebuild Reports";
              });
          }

          const ownerTest = ev.target.closest("[data-test-owner-email]");
          if (ownerTest) {
            ownerTest.disabled = true;
            ownerTest.textContent = "Sending...";
            adminGet("testOwnerEmail", {})
              .then((res) => {
                if (!res || !res.ok) {
                  alert(
                    (res && res.message) ||
                      "Backend did not confirm owner test email; check action."
                  );
                } else {
                  alert("Owner test email triggered.");
                }
              })
              .catch((err) => {
                console.error(err);
                alert(
                  "Error calling testOwnerEmail. Backend action may not be wired yet."
                );
              })
              .finally(() => {
                ownerTest.disabled = false;
                ownerTest.textContent = "Send Test Owner Email";
              });
          }

          const playerTest = ev.target.closest("[data-test-player-email]");
          if (playerTest) {
            playerTest.disabled = true;
            playerTest.textContent = "Sending...";
            adminGet("testPlayerEmail", {})
              .then((res) => {
                if (!res || !res.ok) {
                  alert(
                    (res && res.message) ||
                      "Backend did not confirm player test email; check action."
                  );
                } else {
                  alert("Player test email triggered.");
                }
              })
              .catch((err) => {
                console.error(err);
                alert(
                  "Error calling testPlayerEmail. Backend action may not be wired yet."
                );
              })
              .finally(() => {
                playerTest.disabled = false;
                playerTest.textContent = "Send Test Player Email";
              });
          }
        });

        /* Grid search / reload */
        document.addEventListener("input", function (ev) {
          const input = ev.target.closest(".ci-grid-search");
          if (!input) return;
          const key = input.getAttribute("data-grid-search");
          if (!key || !state.grids[key]) return;
          state.grids[key].searchTerm = (input.value || "").trim();
          applyGridFilterAndRender(key);
        });

        document.addEventListener("click", function (ev) {
          const reloadBtn = ev.target.closest("[data-grid-reload]");
          if (reloadBtn) {
            const key = reloadBtn.getAttribute("data-grid-reload");
            if (key) ensureGridLoaded(key, true);
          }
        });

        /* Table header sort */
        document.addEventListener("click", function (ev) {
          const th = ev.target.closest("th[data-grid-key]");
          if (!th) return;
          const key = th.getAttribute("data-grid-key");
          const colIndex = parseInt(th.getAttribute("data-col-index") || "-1", 10);
          if (!key || colIndex < 0 || !state.grids[key]) return;

          const grid = state.grids[key];
          const existing = grid.sortKey;
          if (existing === colIndex) {
            grid.sortDir = grid.sortDir === "asc" ? "desc" : "asc";
          } else {
            grid.sortKey = colIndex;
            grid.sortDir = "desc";
          }
          applyGridFilterAndRender(key);
        });

        /* Status select (Cashouts + Rewards) */
        document.addEventListener("change", function (ev) {
          const select = ev.target.closest(".ci-status-select");
          if (!select) return;

          const gridKey = select.getAttribute("data-grid-key");
          const rowIdx = parseInt(select.getAttribute("data-row-idx") || "-1", 10);
          const colIdx = parseInt(select.getAttribute("data-col-idx") || "-1", 10);
          const value = select.value;

          if (!gridKey || rowIdx < 0 || colIdx < 0) return;
          const grid = state.grids[gridKey];
          if (!grid) return;

          if (!grid.rowNumbers || !Array.isArray(grid.rowNumbers)) {
            alert(
              "Row mapping (rowNumbers) not provided by backend. Please add rowNumbers to getSheetDataForGrid response."
            );
            return;
          }

          const sheetRowNumber = grid.rowNumbers[rowIdx];
          if (!sheetRowNumber) {
            alert("Unable to determine sheet row for this record.");
            return;
          }

          const sheetName = grid.sheetName;
          const payload = {
            sheetName: sheetName,
            rowIndex: sheetRowNumber - 1,
            colIndex: colIdx,
            value: value,
          };

          select.disabled = true;

          adminGet("updateCell", payload)
            .then((res) => {
              if (!res || !res.ok) {
                alert(
                  (res && res.message) ||
                    "updateCell did not confirm; check backend action."
                );
                return;
              }
              grid.rows[rowIdx][colIdx] = value;
              applyGridFilterAndRender(gridKey);
            })
            .catch((err) => {
              console.error(err);
              alert("Error calling updateCell; see console/backend.");
            })
            .finally(() => {
              select.disabled = false;
            });
        });

        /* Player row selection / drilldowns / blacklist */
        document.addEventListener("click", function (ev) {
          const playerRow = ev.target.closest("tr[data-grid-key='players']");
          if (playerRow) {
            const rowIdx = parseInt(
              playerRow.getAttribute("data-row-idx") || "-1",
              10
            );
            if (!isNaN(rowIdx) && rowIdx >= 0) {
              selectPlayer(rowIdx);
            }
          }

          const drillBtn = ev.target.closest("[data-player-drill]");
          if (drillBtn) {
            const type = drillBtn.getAttribute("data-player-drill");
            handlePlayerDrill(type);
          }

          const addBlkBtn = ev.target.closest("[data-player-add-blacklist]");
          if (addBlkBtn) {
            addSelectedPlayerToBlacklist();
          }
        });

        /* Kick things off on load by focusing login user */
        if (loginUser) loginUser.focus();
      }

      /* DASHBOARD */

      function loadDashboard(force) {
        // KPIs driven off Reports grid if present
        ensureGridLoaded("reports", !!force, function () {
          renderDashboardKpis();
        });
        loadDashboardCashouts();
      }

      function loadDashboardCashouts() {
        const container = document.querySelector("[data-dashboard-cashouts]");
        if (!container) return;
        container.textContent = "Loading recent cashouts...";

        adminGet("getSheetDataForGrid", {
          sheetKey: "cashouts",
          sheetName: "Cashouts",
          limit: 5,
        })
          .then((res) => {
            if (!res || !res.ok) {
              container.textContent =
                (res && res.message) || "Unable to load cashouts.";
              return;
            }
            const headers = res.headers || [];
            const rows = res.rows || [];
            renderDashboardCashouts(container, headers, rows);
          })
          .catch((err) => {
            console.error(err);
            container.textContent = "Error loading recent cashouts.";
          });
      }

      function renderDashboardCashouts(container, headers, rows) {
        const idxRequestedAt =
          headers.indexOf("Requested At") >= 0
            ? headers.indexOf("Requested At")
            : headers.indexOf("Timestamp");
        const idxUsd =
          headers.indexOf("USD Equivalent") >= 0
            ? headers.indexOf("USD Equivalent")
            : headers.indexOf("Requested Chips");
        const idxUser = headers.indexOf("Username");
        const idxMethod = headers.indexOf("Payout Method");
        const idxStatus = headers.indexOf("Status");

        let html = '<table><thead><tr>';
        html += "<th>When</th>";
        html += "<th>Username</th>";
        html += "<th>Requested</th>";
        html += "<th>Method</th>";
        html += "<th>Status</th>";
        html += "</tr></thead><tbody>";

        if (!rows.length) {
          html +=
            '<tr><td colspan="5" class="ci-muted">No recent cashouts.</td></tr>';
        } else {
          rows.forEach((row) => {
            const tsVal =
              idxRequestedAt >= 0 ? safeCell(row[idxRequestedAt]) : "";
            const userVal = idxUser >= 0 ? safeCell(row[idxUser]) : "";
            const usdVal = idxUsd >= 0 ? safeCell(row[idxUsd]) : "";
            const methodVal = idxMethod >= 0 ? safeCell(row[idxMethod]) : "";
            const statusVal = idxStatus >= 0 ? safeCell(row[idxStatus]) : "";

            html += "<tr>";
            html += "<td>" + formatShortDate(tsVal) + "</td>";
            html += "<td>" + escapeHtml(userVal) + "</td>";
            html += "<td>" + escapeHtml(formatUsd(usdVal)) + "</td>";
            html += "<td>" + escapeHtml(methodVal) + "</td>";
            html += "<td>" + escapeHtml(statusVal) + "</td>";
            html += "</tr>";
          });
        }

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function renderDashboardKpis() {
        const kpiEl = document.getElementById("ci-dashboard-kpis");
        if (!kpiEl) return;
        const grid = state.grids.reports;
        if (!grid || !grid.headers || !grid.headers.length || !grid.rows.length) {
          kpiEl.innerHTML =
            '<div class="ci-muted">Reports snapshot not yet generated.</div>';
          return;
        }

        const headers = grid.headers;
        const rows = grid.rows;
        const latest = rows[0];

        const idxDate = headers.indexOf("Report Date");
        const idxInPlay = headers.indexOf("Total Chips In Play");
        const idxPurchased = headers.indexOf("Total Purchased");
        const idxCashed = headers.indexOf("Total Cashed Out");
        const idxNet = headers.indexOf("House Net Win (Net)");
        const idxActive = headers.indexOf("Active Players");

        const dateVal = idxDate >= 0 ? safeCell(latest[idxDate]) : "";
        const inPlayVal = idxInPlay >= 0 ? safeCell(latest[idxInPlay]) : "";
        const purchVal = idxPurchased >= 0 ? safeCell(latest[idxPurchased]) : "";
        const cashVal = idxCashed >= 0 ? safeCell(latest[idxCashed]) : "";
        const netVal = idxNet >= 0 ? safeCell(latest[idxNet]) : "";
        const activeVal = idxActive >= 0 ? safeCell(latest[idxActive]) : "";

        kpiEl.innerHTML = `
          <div>
            <div class="ci-side-field-label">Report Date</div>
            <div class="ci-side-field-value">${escapeHtml(
              formatShortDate(dateVal)
            )}</div>
          </div>
          <div>
            <div class="ci-side-field-label">Chips In Play</div>
            <div class="ci-side-field-value">${escapeHtml(
              formatNumber(inPlayVal)
            )}</div>
          </div>
          <div>
            <div class="ci-side-field-label">Total Purchased (USD)</div>
            <div class="ci-side-field-value">${escapeHtml(
              formatUsd(purchVal)
            )}</div>
          </div>
          <div>
            <div class="ci-side-field-label">Total Cashed Out (USD)</div>
            <div class="ci-side-field-value">${escapeHtml(
              formatUsd(cashVal)
            )}</div>
          </div>
          <div>
            <div class="ci-side-field-label">House Net Win</div>
            <div class="ci-side-field-value">${escapeHtml(
              formatUsd(netVal)
            )}</div>
          </div>
          <div>
            <div class="ci-side-field-label">Active Players</div>
            <div class="ci-side-field-value">${escapeHtml(
              formatNumber(activeVal)
            )}</div>
          </div>
        `;
      }

      /* GRIDS */

      function ensureGridLoaded(key, force, callback) {
        if (!GRID_CONFIG[key]) return;
        const existing = state.grids[key];
        if (existing && existing.loaded && !force) {
          if (callback) callback();
          if (key === "players") renderPlayersDecorations();
          return;
        }

        const cfg = GRID_CONFIG[key];
        const limit = cfg.limit || 500;

        adminGet("getSheetDataForGrid", {
          sheetKey: key,
          sheetName: cfg.sheetName,
          limit: limit,
        })
          .then((res) => {
            if (!res || !res.ok) {
              console.error("Grid load error", key, res);
              const tableWrap = document.querySelector(
                '[data-grid-table="' + key + '"]'
              );
              if (tableWrap) {
                tableWrap.innerHTML =
                  '<div class="ci-muted" style="padding:8px;">Unable to load ' +
                  escapeHtml(cfg.sheetName) +
                  ".</div>";
              }
              return;
            }

            const headers = res.headers || [];
            const rows = res.rows || [];
            const rowNumbers = res.rowNumbers || null;

            state.grids[key] = {
              key: key,
              sheetName: cfg.sheetName,
              loaded: true,
              headers: headers,
              rows: rows,
              rowNumbers: rowNumbers,
              sortKey: null,
              sortDir: "desc",
              searchTerm: "",
            };

            applyGridFilterAndRender(key);

            if (key === "players") {
              renderPlayersDecorations();
            }
            if (callback) callback();
          })
          .catch((err) => {
            console.error("Grid load error", key, err);
            const tableWrap = document.querySelector(
              '[data-grid-table="' + key + '"]'
            );
            if (tableWrap) {
              tableWrap.innerHTML =
                '<div class="ci-muted" style="padding:8px;">Error loading ' +
                escapeHtml(cfg.sheetName) +
                ".</div>";
            }
          });
      }

      function applyGridFilterAndRender(key) {
        const grid = state.grids[key];
        if (!grid || !grid.headers) return;

        const term = (grid.searchTerm || "").toLowerCase();
        let indices = [];
        for (let i = 0; i < grid.rows.length; i++) {
          indices.push(i);
        }

        if (term) {
          indices = indices.filter((idx) => {
            const row = grid.rows[idx];
            for (let c = 0; c < grid.headers.length; c++) {
              const cell = row[c];
              if (
                cell !== null &&
                cell !== undefined &&
                String(cell).toLowerCase().indexOf(term) !== -1
              ) {
                return true;
              }
            }
            return false;
          });
        }

        if (grid.sortKey !== null && grid.sortKey >= 0) {
          const col = grid.sortKey;
          const dir = grid.sortDir === "asc" ? 1 : -1;
          indices.sort((a, b) => {
            const av = grid.rows[a][col];
            const bv = grid.rows[b][col];
            const na = parseFloat(av);
            const nb = parseFloat(bv);
            if (!isNaN(na) && !isNaN(nb)) {
              if (na < nb) return -1 * dir;
              if (na > nb) return 1 * dir;
              return 0;
            }
            const sa = String(av || "").toLowerCase();
            const sb = String(bv || "").toLowerCase();
            if (sa < sb) return -1 * dir;
            if (sa > sb) return 1 * dir;
            return 0;
          });
        }

        grid.filteredIndices = indices;
        renderGrid(key);
      }

      function renderGrid(key) {
        const grid = state.grids[key];
        if (!grid || !grid.headers) return;

        const tableWrap = document.querySelector(
          '[data-grid-table="' + key + '"]'
        );
        if (!tableWrap) return;

        const headers = grid.headers;
        const indices = grid.filteredIndices || [];

        let html = '<table class="ci-table"><thead><tr>';

        for (let c = 0; c < headers.length; c++) {
          const label = headers[c] || "";
          const sorted = grid.sortKey === c;
          const arrow = sorted ? (grid.sortDir === "asc" ? "▲" : "▼") : "";
          html +=
            '<th data-grid-key="' +
            key +
            '" data-col-index="' +
            c +
            '"><span class="ci-th-sort">' +
            escapeHtml(label) +
            (arrow
              ? '<span class="ci-sort-indicator">' + arrow + "</span>"
              : "") +
            "</span></th>";
        }

        html += "</tr></thead><tbody>";

        if (!indices.length) {
          html +=
            '<tr><td colspan="' +
            headers.length +
            '" class="ci-muted">No records.</td></tr>';
        } else {
          const isStatusEditable = key === "cashouts" || key === "rewards";
          const statusColIndex = headers.indexOf("Status");

          for (let i = 0; i < indices.length; i++) {
            const rowIndex = indices[i];
            const row = grid.rows[rowIndex];

            const trAttrs =
              key === "players"
                ? ' data-grid-key="players" data-row-idx="' + rowIndex + '"'
                : "";

            html += "<tr" + trAttrs + ">";

            for (let c = 0; c < headers.length; c++) {
              const val = safeCell(row[c]);
              if (isStatusEditable && c === statusColIndex) {
                const options = ["Pending", "Review", "Approved", "Rejected"];
                const current = val || "Pending";
                html += "<td>";
                html +=
                  '<select class="ci-status-select" data-grid-key="' +
                  key +
                  '" data-row-idx="' +
                  rowIndex +
                  '" data-col-idx="' +
                  c +
                  '">';
                options.forEach((opt) => {
                  const selected =
                    String(opt).toLowerCase() ===
                    String(current).toLowerCase()
                      ? ' selected="selected"'
                      : "";
                  html +=
                    '<option value="' +
                    escapeHtml(opt) +
                    '"' +
                    selected +
                    ">" +
                    escapeHtml(opt) +
                    "</option>";
                });
                html += "</select>";
                html += "</td>";
              } else if (key === "cashouts") {
                // Format USD Equivalent nicely in Cashouts
                if (headers[c] === "USD Equivalent") {
                  html += "<td>" + escapeHtml(formatUsd(val)) + "</td>";
                } else {
                  html += "<td>" + escapeHtml(String(val)) + "</td>";
                }
              } else {
                html += "<td>" + escapeHtml(String(val)) + "</td>";
              }
            }

            html += "</tr>";
          }
        }

        html += "</tbody></table>";
        tableWrap.innerHTML = html;
      }

      /* PLAYERS DETAIL + DRILLDOWNS */

      function renderPlayersDecorations() {
        // could add extra styling or logic; currently handled by row click + detail
      }

      function selectPlayer(rowIndex) {
        const grid = state.grids.players;
        if (!grid || !grid.rows[rowIndex]) return;

        const row = grid.rows[rowIndex];
        const headers = grid.headers;
        const fields = {};
        for (let i = 0; i < headers.length; i++) {
          fields[headers[i] || "Col" + (i + 1)] = safeCell(row[i]);
        }

        state.selectedPlayer = {
          rowIndex: rowIndex,
          sheetRow: grid.rowNumbers ? grid.rowNumbers[rowIndex] : null,
          headers: headers.slice(),
          row: row.slice(),
          fields: fields,
        };

        renderPlayerDetail();
      }

      function renderPlayerDetail() {
        const container = document.querySelector("[data-player-detail]");
        if (!container) return;

        const player = state.selectedPlayer;
        if (!player) {
          container.innerHTML = `
            <div class="ci-side-header">
              <div class="ci-side-title-block">
                <div class="ci-side-title">Player Details</div>
                <div class="ci-side-sub">
                  Select a player row from the grid to view full details and drilldowns.
                </div>
              </div>
            </div>
          `;
          return;
        }

        const f = player.fields;
        const playerId =
          f["Player ID"] || f["PlayerID"] || f["ID"] || f["Username"] || "";
        const username = f["Username"] || "";
        const fullName = f["Full Name"] || f["Legal Name"] || "";
        const email = f["Email"] || "";
        const kyc = f["KYC Status"] || "";
        const risk = f["Risk Status"] || "";
        const vip = f["VIP Level"] || "";
        const flags = f["Flag Notes"] || "";
        const selfUntil = f["Self-Exclusion Until"] || "";
        const selfReason = f["Self-Exclusion Reason"] || "";
        const selfActive = f["Self-Exclusion Active"] || "";
        const balance =
          f["Current Balance"] ||
          f["Balance"] ||
          f["Chip Balance"] ||
          f["Total Chips"] ||
          "";

        let fullRecordHtml = "";
        player.headers.forEach((h, idx) => {
          const label = h || "Col " + (idx + 1);
          const val = safeCell(player.row[idx]);
          if (val === "" && label.toLowerCase().indexOf("notes") === -1) {
            return;
          }
          fullRecordHtml += `
            <div class="ci-side-full-record-row">
              <div class="ci-side-full-record-label">${escapeHtml(label)}</div>
              <div class="ci-side-full-record-value">${escapeHtml(
                String(val)
              )}</div>
            </div>
          `;
        });

        container.innerHTML = `
          <div class="ci-side-header">
            <div class="ci-side-title-block">
              <div class="ci-side-title">
                ${escapeHtml(username || fullName || playerId || "Player")}
              </div>
              <div class="ci-side-sub">
                Player ID: ${escapeHtml(playerId || "N/A")} · Email: ${escapeHtml(
          email || "N/A"
        )}
              </div>
            </div>
            <div class="ci-side-actions">
              <button type="button" class="ci-side-pill" data-player-drill="log">
                Log
              </button>
              <button type="button" class="ci-side-pill" data-player-drill="ledger">
                Game Ledger
              </button>
              <button type="button" class="ci-side-pill" data-player-drill="rewards">
                Rewards
              </button>
              <button type="button" class="ci-side-pill" data-player-drill="cashouts">
                Cashouts
              </button>
              <button type="button" class="ci-side-pill" data-player-add-blacklist>
                Add to Blacklist
              </button>
            </div>
          </div>

          <div class="ci-side-section">
            <h4>Account</h4>
            <div class="ci-side-grid">
              <div>
                <div class="ci-side-field-label">Player ID</div>
                <div class="ci-side-field-value">${escapeHtml(playerId)}</div>
              </div>
              <div>
                <div class="ci-side-field-label">Username</div>
                <div class="ci-side-field-value">${escapeHtml(username)}</div>
              </div>
              <div>
                <div class="ci-side-field-label">Full / Legal Name</div>
                <div class="ci-side-field-value">${escapeHtml(fullName)}</div>
              </div>
              <div>
                <div class="ci-side-field-label">Email</div>
                <div class="ci-side-field-value">${escapeHtml(email)}</div>
              </div>
              <div>
                <div class="ci-side-field-label">Current Balance (chips)</div>
                <div class="ci-side-field-value">${escapeHtml(
                  formatNumber(balance)
                )}</div>
              </div>
              <div>
                <div class="ci-side-field-label">Flags / Notes</div>
                <div class="ci-side-field-value">${escapeHtml(flags)}</div>
              </div>
            </div>
          </div>

          <div class="ci-side-section">
            <h4>KYC · Risk · VIP</h4>
            <div class="ci-side-grid">
              <div>
                <div class="ci-side-field-label">KYC Status</div>
                <div class="ci-side-field-value">${escapeHtml(kyc)}</div>
              </div>
              <div>
                <div class="ci-side-field-label">Risk Status</div>
                <div class="ci-side-field-value">${escapeHtml(risk)}</div>
              </div>
              <div>
                <div class="ci-side-field-label">VIP Level</div>
                <div class="ci-side-field-value">${escapeHtml(vip)}</div>
              </div>
            </div>
          </div>

          <div class="ci-side-section">
            <h4>Self-Exclusion</h4>
            <div class="ci-side-grid">
              <div>
                <div class="ci-side-field-label">Active</div>
                <div class="ci-side-field-value">${escapeHtml(
                  selfActive || "No"
                )}</div>
              </div>
              <div>
                <div class="ci-side-field-label">Until</div>
                <div class="ci-side-field-value">${escapeHtml(
                  formatShortDate(selfUntil)
                )}</div>
              </div>
              <div>
                <div class="ci-side-field-label">Reason</div>
                <div class="ci-side-field-value">${escapeHtml(
                  selfReason || "-"
                )}</div>
              </div>
            </div>
          </div>

          <div class="ci-side-section ci-side-full-record">
            <h4>Full Player Record</h4>
            ${fullRecordHtml || '<div class="ci-muted">No additional fields.</div>'}
          </div>
        `;
      }

      function handlePlayerDrill(type) {
        const player = state.selectedPlayer;
        if (!player) return;

        const f = player.fields;
        const pid =
          f["Player ID"] || f["PlayerID"] || f["Username"] || f["Email"] || "";
        if (!pid) return;

        let tabKey = null;
        let gridKey = null;

        if (type === "log") {
          tabKey = "log";
          gridKey = "log";
        } else if (type === "ledger") {
          tabKey = "gameLedger";
          gridKey = "gameLedger";
        } else if (type === "rewards") {
          tabKey = "rewards";
          gridKey = "rewards";
        } else if (type === "cashouts") {
          tabKey = "cashouts";
          gridKey = "cashouts";
        }

        if (!tabKey || !gridKey) return;

        if (window.setActiveTab) {
          window.setActiveTab(tabKey);
        }

        ensureGridLoaded(gridKey, false, function () {
          const searchInput = document.querySelector(
            '[data-grid-search="' + gridKey + '"]'
          );
          if (searchInput) {
            searchInput.value = pid;
          }
          if (state.grids[gridKey]) {
            state.grids[gridKey].searchTerm = pid;
            applyGridFilterAndRender(gridKey);
          }
        });
      }

      function addSelectedPlayerToBlacklist() {
        const player = state.selectedPlayer;
        if (!player) return;
        const f = player.fields;

        const username = f["Username"] || "";
        const legalName = f["Full Name"] || f["Legal Name"] || "";
        const email = f["Email"] || "";
        const playerId =
          f["Player ID"] || f["PlayerID"] || f["ID"] || f["Username"] || "";

        const label =
          legalName || username || playerId || email || "this player";

        if (
          !confirm(
            "Add " +
              label +
              " to the Blacklist sheet? (Requires backend addToBlacklist action.)"
          )
        ) {
          return;
        }

        adminPost("addToBlacklist", {
          username: username,
          legalName: legalName,
          playerId: playerId,
          email: email,
        })
          .then((res) => {
            if (!res || !res.ok) {
              alert(
                (res && res.message) ||
                  "Backend did not confirm addToBlacklist; check action."
              );
              return;
            }
            alert("Player added to Blacklist.");
            ensureGridLoaded("blacklist", true);
          })
          .catch((err) => {
            console.error(err);
            alert(
              "Error calling addToBlacklist. Backend action may not be wired yet."
            );
          });
      }

      /* REPORTS GRAPH */

      function renderReportsGraph() {
        const wrap = document.querySelector("[data-reports-graph]");
        if (!wrap) return;
        const grid = state.grids.reports;
        if (!grid || !grid.headers || !grid.headers.length || !grid.rows.length) {
          wrap.innerHTML =
            '<div class="ci-muted">No report rows available for graph.</div>';
          return;
        }

        const headers = grid.headers;
        const rows = grid.rows.slice(0, 30);

        const idxDate = headers.indexOf("Report Date");
        const idxPurchased = headers.indexOf("Total Purchased");
        const idxCashed = headers.indexOf("Total Cashed Out");
        const idxNet = headers.indexOf("House Net Win (Net)");
        const idxActive = headers.indexOf("Active Players");

        let maxAbs = 0;
        rows.forEach((row) => {
          const p = parseFloat(row[idxPurchased] || 0);
          const c = parseFloat(row[idxCashed] || 0);
          const n = parseFloat(row[idxNet] || 0);
          const a = parseFloat(row[idxActive] || 0);
          maxAbs = Math.max(
            maxAbs,
            Math.abs(p) || 0,
            Math.abs(c) || 0,
            Math.abs(n) || 0,
            Math.abs(a) || 0
          );
        });
        if (!maxAbs || !isFinite(maxAbs)) maxAbs = 1;

        let html = "";

        rows.forEach((row) => {
          const dateVal = idxDate >= 0 ? safeCell(row[idxDate]) : "";
          const p = parseFloat(row[idxPurchased] || 0) || 0;
          const c = parseFloat(row[idxCashed] || 0) || 0;
          const n = parseFloat(row[idxNet] || 0) || 0;
          const a = parseFloat(row[idxActive] || 0) || 0;

          const pWidth = Math.max(4, (Math.abs(p) / maxAbs) * 100);
          const cWidth = Math.max(4, (Math.abs(c) / maxAbs) * 100);
          const nWidth = Math.max(4, (Math.abs(n) / maxAbs) * 100);
          const aWidth = Math.max(4, (Math.abs(a) / maxAbs) * 100);

          html += `
            <div class="ci-kpi-row">
              <div class="ci-kpi-label">${escapeHtml(
                formatShortDate(dateVal)
              )}</div>
              <div class="ci-kpi-bars">
                <div class="ci-kpi-bar" style="width:${pWidth}%;"></div>
                <div class="ci-kpi-bar ci-kpi-bar-secondary" style="width:${cWidth}%;"></div>
                <div class="ci-kpi-bar ci-kpi-bar-tertiary" style="width:${nWidth}%;"></div>
              </div>
              <div class="ci-kpi-legend">
                <span><span class="ci-kpi-dot ci-kpi-dot-primary"></span>Purchased: ${escapeHtml(
                  formatUsd(p)
                )}</span>
                <span><span class="ci-kpi-dot ci-kpi-dot-secondary"></span>Cashed Out: ${escapeHtml(
                  formatUsd(c)
                )}</span>
                <span><span class="ci-kpi-dot ci-kpi-dot-tertiary"></span>Net: ${escapeHtml(
                  formatUsd(n)
                )}</span>
                ${
                  isNaN(a)
                    ? ""
                    : `<span><span class="ci-kpi-dot ci-kpi-dot-primary"></span>Active: ${escapeHtml(
                        formatNumber(a)
                      )}</span>`
                }
              </div>
            </div>
          `;
        });

        wrap.innerHTML = html || '<div class="ci-muted">No rows to graph.</div>';
      }

      /* HELPERS */

      function safeCell(v) {
        if (v === null || v === undefined) return "";
        return v;
      }

      function escapeHtml(str) {
        str = String(str === null || str === undefined ? "" : str);
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function formatNumber(val) {
        if (val === null || val === undefined || val === "") return "";
        const n = Number(val);
        if (!isNaN(n)) {
          return n.toLocaleString("en-US", {
            maximumFractionDigits: 2,
          });
        }
        return val;
      }

      function formatUsd(val) {
        if (val === null || val === undefined || val === "") return "$0.00";
        const n = Number(val);
        if (!isNaN(n)) {
          return (
            "$" +
            n.toLocaleString("en-US", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })
          );
        }
        const s = String(val).trim();
        if (!s) return "$0.00";
        if (s[0] === "$") return s;
        return "$" + s;
      }

      function formatShortDate(val) {
        if (!val) return "";
        // If it's already a nice string, just return it
        if (typeof val === "string") {
          return val;
        }
        try {
          const d = new Date(val);
          if (!isNaN(d.getTime())) {
            return d.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            });
          }
        } catch (e) {
          // ignore
        }
        return String(val);
      }

      /* Init */
      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</div>
