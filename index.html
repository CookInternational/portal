<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cook International Casino — Admin Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #05020b;
      --card-bg: radial-gradient(circle at top, #372257 0, #07030f 55%, #020007 100%);
      --border: rgba(247, 216, 122, 0.35);
      --accent: #f7d87a;
      --accent-soft: rgba(247, 216, 122, 0.12);
      --text-main: #f9f6ff;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
      --surface: rgba(15, 23, 42, 0.92);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #02000a;
      color: var(--text-main);
    }

    .ci-admin-root {
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px;
      background:
        radial-gradient(circle at top, #372257 0, #05020b 55%, #020007 100%);
    }

    .ci-admin-shell {
      width: 100%;
      max-width: 1280px;
      min-height: calc(100vh - 64px);
      background: var(--card-bg);
      border-radius: 26px;
      border: 1px solid var(--border);
      box-shadow:
        0 24px 80px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      overflow: visible;
    }

    .ci-admin-header {
      padding: 18px 24px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .ci-admin-brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .ci-admin-logo {
      width: 185px;
      max-width: 48vw;
      height: auto;
      display: block;
    }

    .ci-admin-titleblock {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ci-admin-kicker {
      font-size: 11px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .ci-admin-title {
      font-size: 18px;
      font-weight: 600;
      color: #fef9c3;
    }

    .ci-admin-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .ci-admin-header-meta {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .ci-admin-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 8px 16px 16px;
      overflow: visible;
    }

    #ci-admin-login-view,
    #ci-admin-app-view {
      width: 100%;
    }

    #ci-admin-login-view {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 0 40px;
    }

    .ci-card {
      background: linear-gradient(
        145deg,
        rgba(17, 24, 39, 0.96),
        rgba(15, 23, 42, 0.96)
      );
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow:
        0 18px 50px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      padding: 24px 22px 22px;
      max-width: 420px;
      width: 100%;
      color: var(--text-main);
    }

    .ci-card h2 {
      margin: 0 0 4px;
      font-size: 20px;
      font-weight: 600;
    }

    .ci-card p {
      margin: 0 0 18px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .ci-field {
      margin-bottom: 14px;
    }

    .ci-field label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .ci-input,
    .ci-select,
    .ci-textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
    }

    .ci-input:focus,
    .ci-select:focus,
    .ci-textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(247, 216, 122, 0.45);
      background: rgba(15, 23, 42, 1);
    }

    .ci-textarea {
      min-height: 72px;
      resize: vertical;
    }

    .ci-input::-webkit-outer-spin-button,
    .ci-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .ci-input[type="number"] {
      -moz-appearance: textfield;
    }

    .ci-btn-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 4px;
    }

    .ci-btn,
    .ci-btn-secondary,
    .ci-btn-ghost,
    .ci-badge {
      font-family: inherit;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: background 0.12s ease, box-shadow 0.12s ease,
        transform 0.06s ease, border-color 0.12s ease;
      white-space: nowrap;
    }

    .ci-btn {
      background: linear-gradient(135deg, #facc6b, #f7d87a);
      color: #221600;
      padding: 7px 16px;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(248, 213, 116, 0.25);
    }

    .ci-btn:hover {
      box-shadow: 0 10px 26px rgba(248, 213, 116, 0.3);
      transform: translateY(-0.5px);
    }

    .ci-btn:active {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
      transform: translateY(0.5px);
    }

    .ci-btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.9);
      padding: 6px 13px;
    }

    .ci-btn-secondary:hover {
      border-color: var(--accent);
      background: rgba(15, 23, 42, 1);
    }

    .ci-btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 5px 11px;
      font-size: 12px;
    }

    .ci-btn-ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(15, 23, 42, 0.9);
    }

    .ci-badge {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.9);
    }

    .ci-badge-online {
      color: var(--success);
      border-color: rgba(74, 222, 128, 0.8);
    }

    .ci-badge-danger {
      color: var(--danger);
      border-color: rgba(248, 113, 113, 0.85);
    }

    .ci-admin-footer {
      padding: 8px 18px 10px;
      border-top: 1px solid rgba(30, 41, 59, 0.8);
      font-size: 11px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      text-align: center;
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.96);
    }

    /* Status + loading */
    .ci-admin-status {
      min-height: 20px;
      padding: 6px 12px;
      font-size: 11px;
      color: var(--text-muted);
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
      display: flex;
      align-items: center;
      gap: 8px;
      max-width: 540px;
      margin: 0 auto 8px;
    }

    .ci-admin-status-error {
      color: var(--danger);
      border-color: rgba(248, 113, 113, 0.85);
      background: rgba(30, 64, 175, 0.1);
    }

    .ci-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      flex-shrink: 0;
    }

    .ci-admin-loading {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center, rgba(15, 23, 42, 0.28), rgba(15, 23, 42, 0.9));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .ci-admin-loading-inner {
      padding: 16px 20px;
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.75);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: #e5e7eb;
    }

    .ci-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      border-top-color: var(--accent);
      animation: ci-spin 0.8s linear infinite;
    }

    @keyframes ci-spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* App view */
    #ci-admin-app-view {
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 6px 0 20px;
    }

    .ci-admin-tabs {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      padding: 4px 2px 2px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(30, 64, 175, 0.5);
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .ci-admin-tabs::-webkit-scrollbar {
      height: 5px;
    }

    .ci-admin-tabs::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }

    .ci-admin-tab {
      border-radius: 999px;
      border: none;
      padding: 5px 12px;
      font-size: 12px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .ci-admin-tab span {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .ci-admin-tab strong {
      font-weight: 500;
    }

    .ci-admin-tab-active {
      background: radial-gradient(circle at top, rgba(247, 216, 122, 0.08), rgba(15, 23, 42, 0.98));
      color: #fef9c3;
      box-shadow:
        0 0 0 1px rgba(248, 213, 116, 0.45),
        0 10px 24px rgba(0, 0, 0, 0.9);
    }

    .ci-admin-tab-active strong {
      color: #fef9c3;
    }

    .ci-admin-panels {
      margin-top: 10px;
      flex: 1;
      min-height: 0;
    }

    .ci-admin-panel {
      display: none;
      border-radius: 22px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(30, 64, 175, 0.8);
      padding: 14px 14px 12px;
      min-height: 420px;
      flex-direction: column;
      overflow: visible;
    }

    .ci-admin-panel-active {
      display: flex;
    }

    .ci-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.85);
      margin-bottom: 8px;
    }

    .ci-panel-header-left h2 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .ci-panel-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .ci-panel-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .ci-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .ci-toolbar-left,
    .ci-toolbar-right {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .ci-toolbar-search-wrap {
      position: relative;
      flex: 1 1 220px;
      min-width: 180px;
    }

    .ci-toolbar-search {
      padding-left: 24px;
    }

    .ci-toolbar-search-icon {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.9);
      box-sizing: border-box;
    }

    .ci-toolbar-search-icon::after {
      content: "";
      position: absolute;
      right: -4px;
      bottom: -5px;
      width: 5px;
      height: 2px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
      transform: rotate(45deg);
    }

    .ci-toolbar label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .ci-toolbar select {
      min-width: 64px;
      font-size: 11px;
    }

    .ci-table-wrap {
      border-radius: 16px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.22), rgba(15, 23, 42, 0.98));
      overflow: hidden;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .ci-table-scroll {
      overflow: auto;
      flex: 1;
    }

    table.ci-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 640px;
    }

    .ci-table thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: rgba(15, 23, 42, 0.98);
    }

    .ci-table th,
    .ci-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.6);
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ci-table th {
      font-weight: 500;
      color: #e5e7eb;
      cursor: pointer;
      position: relative;
      user-select: none;
    }

    .ci-table th[data-sortable="false"] {
      cursor: default;
    }

    .ci-table th span.ci-sort-indicator {
      font-size: 9px;
      margin-left: 4px;
      opacity: 0.7;
    }

    .ci-table tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.88);
    }

    .ci-table tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.96);
    }

    .ci-table tr:hover td {
      background: rgba(30, 64, 175, 0.6);
    }

    .ci-table-row-selected td {
      background: rgba(247, 216, 122, 0.08) !important;
    }

    .ci-tag {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 1px 8px 2px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: var(--text-muted);
    }

    .ci-tag-green {
      border-color: rgba(74, 222, 128, 0.9);
      color: var(--success);
    }

    .ci-tag-red {
      border-color: rgba(248, 113, 113, 0.9);
      color: var(--danger);
    }

    .ci-tag-gold {
      border-color: rgba(247, 216, 122, 0.9);
      color: #fef9c3;
    }

    .ci-pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 8px;
      font-size: 11px;
      color: var(--text-muted);
      border-top: 1px solid rgba(30, 64, 175, 0.9);
      background: rgba(15, 23, 42, 0.98);
    }

    .ci-pagination span {
      white-space: nowrap;
    }

    .ci-link-button {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      color: #bfdbfe;
      cursor: pointer;
      font: inherit;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .ci-link-button:hover {
      color: #f9f6ff;
    }

    .ci-split {
      display: grid;
      grid-template-columns: minmax(0, 2.3fr) minmax(260px, 1.2fr);
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .ci-split-main {
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
    }

    .ci-split-side {
      border-radius: 16px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.25), rgba(15, 23, 42, 0.98));
      padding: 10px 10px 8px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .ci-side-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.8);
      padding-bottom: 4px;
      margin-bottom: 4px;
    }

    .ci-side-title h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .ci-side-section {
      border-radius: 12px;
      border: 1px solid rgba(30, 64, 175, 0.85);
      padding: 6px 7px;
      background: rgba(15, 23, 42, 0.95);
      margin-bottom: 6px;
    }

    .ci-side-section h4 {
      margin: 0 0 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .ci-side-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .ci-side-label {
      color: var(--text-muted);
    }

    .ci-side-value {
      text-align: right;
    }

    .ci-side-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 8px;
      font-size: 11px;
    }

    .ci-side-controls-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .ci-side-callout {
      font-size: 11px;
      color: var(--text-muted);
      padding: 4px 6px;
      border-radius: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      margin-top: 2px;
    }

    .ci-kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .ci-kpi-card {
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.3), rgba(15, 23, 42, 0.98));
      padding: 8px 9px 7px;
      font-size: 11px;
    }

    .ci-kpi-label {
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .ci-kpi-value {
      font-size: 16px;
      font-weight: 600;
      color: #fef9c3;
    }

    .ci-kpi-note {
      font-size: 10px;
      color: var(--text-muted);
    }

    .ci-dashboard-bottom {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 10px;
      margin-top: 6px;
      min-height: 0;
      flex: 1;
    }

    .ci-dashboard-card {
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 8px 9px 6px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .ci-dashboard-card h3 {
      margin: 0 0 4px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .ci-dashboard-card ul {
      list-style: none;
      padding: 0;
      margin: 2px 0 0;
      font-size: 11px;
    }

    .ci-dashboard-card li {
      margin-bottom: 3px;
      color: var(--text-muted);
    }

    .ci-dashboard-mini-table {
      border-radius: 10px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 4px;
      margin-top: 4px;
      overflow: auto;
      max-height: 240px;
    }

    .ci-dashboard-mini-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      min-width: 320px;
    }

    .ci-dashboard-mini-table th,
    .ci-dashboard-mini-table td {
      border-bottom: 1px solid rgba(30, 64, 175, 0.75);
      padding: 4px 5px;
      white-space: nowrap;
    }

    /* Small utility */
    .ci-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .ci-pill {
      border-radius: 999px;
      padding: 2px 6px 3px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: var(--text-muted);
    }

    /* Responsive tweaks */
    @media (max-width: 960px) {
      .ci-admin-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .ci-admin-header-meta {
        text-align: left;
      }

      .ci-split {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 600px) {
      .ci-admin-shell {
        border-radius: 0;
      }

      .ci-admin-root {
        padding: 0;
      }

      .ci-admin-main {
        padding: 8px 10px 12px;
      }

      .ci-admin-panel {
        max-height: none;
      }
    }

    /* Print: only print active panel content */
    @media print {
      body {
        background: #ffffff;
      }

      .ci-admin-root {
        padding: 0;
      }

      .ci-admin-shell {
        min-height: auto;
        box-shadow: none;
        border-radius: 0;
      }

      .ci-admin-header,
      .ci-admin-footer,
      .ci-admin-tabs,
      #ci-admin-login-view,
      .ci-admin-status,
      .ci-pagination,
      .ci-admin-loading {
        display: none !important;
      }

      .ci-admin-panel {
        display: none !important;
        border: none;
        max-height: none;
      }

      .ci-admin-panel-active {
        display: block !important;
        border: none;
        box-shadow: none;
      }
    }
  </style>
</head>

<body>
  <div class="ci-admin-root">
    <div class="ci-admin-shell">
      <header class="ci-admin-header">
        <div class="ci-admin-brand">
          <img
            src="https://www.cook-international.com/s/CookIntlCasino.png"
            alt="Cook International Casino"
            class="ci-admin-logo"
          />
          <div class="ci-admin-titleblock">
            <div class="ci-admin-kicker">Cook International Casino</div>
            <div class="ci-admin-title">Admin Portal &amp; House Dashboard</div>
            <div class="ci-admin-subtitle"></div>
          </div>
        </div>
        <div class="ci-admin-header-meta">
          <div>Status: <span class="ci-badge ci-badge-online" id="ci-admin-status-badge">Offline</span></div>
          <div class="ci-mono" style="margin-top: 2px; opacity: 0.8;">
            Web App: <span id="ci-admin-webapp-label">Script Endpoint</span>
          </div>
        </div>
      </header>

      <main class="ci-admin-main">
        <div id="ci-admin-status-strip" class="ci-admin-status">
          <span class="ci-dot"></span>
          <span id="ci-admin-status-text">Enter your admin credentials to unlock the portal.</span>
        </div>

        <!-- LOGIN VIEW -->
        <section id="ci-admin-login-view">
          <div class="ci-card">
            <h2>Admin Login</h2>
            <p>
              Sign in with your internal Cook International Casino admin credentials.
              This panel is for house use only.
            </p>

            <form id="ci-admin-login-form" autocomplete="off">
              <div class="ci-field">
                <label for="ci-admin-username">Admin Email / Username</label>
                <input
                  id="ci-admin-username"
                  class="ci-input"
                  type="email"
                  inputmode="email"
                  autocomplete="off"
                  placeholder="info@cook-international.com"
                  required
                />
              </div>

              <div class="ci-field">
                <label for="ci-admin-password">Password</label>
                <input
                  id="ci-admin-password"
                  class="ci-input"
                  type="password"
                  autocomplete="off"
                  placeholder="Enter admin password"
                  required
                />
              </div>

              <div class="ci-btn-row">
                <button type="submit" class="ci-btn">Sign In</button>
                <button type="button" class="ci-btn-secondary" id="ci-admin-login-reset">
                  Clear
                </button>
              </div>
            </form>

            <div style="margin-top: 14px; font-size: 11px; color: var(--text-muted);">
              All activity in this portal is logged to <span class="ci-mono">Admin Log</span>.
            </div>
          </div>
        </section>

        <!-- APP VIEW -->
        <section id="ci-admin-app-view">
          <!-- Tabs -->
          <nav class="ci-admin-tabs" aria-label="Admin sections">
            <button type="button" class="ci-admin-tab" data-tab="dashboard">
              <span>DASHBOARD</span><strong>Overview</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="players">
              <span>PLAYERS</span><strong>Accounts</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="log">
              <span>LOG</span><strong>Events</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="gameLedger">
              <span>LEDGER</span><strong>Game Rounds</strong>
            </button>

            <!-- Back office tabs, in requested order -->
            <button type="button" class="ci-admin-tab" data-tab="adminLog">
              <span>ADMIN</span><strong>Log</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="rewards">
              <span>REWARDS</span><strong>Ledger</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="cashouts">
              <span>CASHOUTS</span><strong>Requests</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="reports">
              <span>REPORTS</span><strong>KPIs</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="blacklist">
              <span>BLACKLIST</span><strong>Risk</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="stripe">
              <span>STRIPE</span><strong>Ledger</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="paypal">
              <span>PAYPAL</span><strong>Ledger</strong>
            </button>
          </nav>

          <!-- Panels -->
          <div class="ci-admin-panels">
            <!-- DASHBOARD PANEL -->
            <section class="ci-admin-panel" data-panel="dashboard">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>House Dashboard</h2>
                  <div class="ci-panel-subtitle">
                    Snapshot of overall casino health and recent activity.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" id="ci-dashboard-refresh-btn">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="dashboard">
                    Print
                  </button>
                </div>
              </div>

              <div style="display:flex;flex-direction:column;gap:8px;flex:1;min-height:0;">
                <div class="ci-kpi-row">
                  <div class="ci-kpi-card">
                    <div class="ci-kpi-label">Total Player Accounts</div>
                    <div class="ci-kpi-value" id="ci-kpi-total-players">–</div>
                    <div class="ci-kpi-note">Unique Player IDs on file.</div>
                  </div>
                  <div class="ci-kpi-card">
                    <div class="ci-kpi-label">Total Chips in Wallets</div>
                    <div class="ci-kpi-value" id="ci-kpi-total-balance">–</div>
                    <div class="ci-kpi-note">Sum of Current Balance from Players.</div>
                  </div>
                  <div class="ci-kpi-card">
                    <div class="ci-kpi-label">Open Cashout Requests (recent)</div>
                    <div class="ci-kpi-value" id="ci-kpi-open-cashouts">–</div>
                    <div class="ci-kpi-note">Latest entries from Cashouts sheet.</div>
                  </div>
                  <div class="ci-kpi-card">
                    <div class="ci-kpi-label">High-Risk Players</div>
                    <div class="ci-kpi-value" id="ci-kpi-high-risk">–</div>
                    <div class="ci-kpi-note">Risk Status set to “High”.</div>
                  </div>
                </div>

                <div class="ci-dashboard-bottom">
                  <div class="ci-dashboard-card">
                    <h3>VIP Snapshot</h3>
                    <ul id="ci-dashboard-vip-list">
                      <li>Loading VIP distribution from Players…</li>
                    </ul>

                    <div class="ci-dashboard-mini-table" id="ci-dashboard-top-players-wrap">
                      <table>
                        <thead>
                          <tr>
                            <th>Player</th>
                            <th>VIP</th>
                            <th>Balance</th>
                          </tr>
                        </thead>
                        <tbody id="ci-dashboard-top-players-body">
                          <tr>
                            <td colspan="3" style="text-align:center;color:var(--text-muted);">
                              Waiting for data…
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="ci-dashboard-card">
                    <h3>Recent Cashouts</h3>
                    <div class="ci-dashboard-mini-table">
                      <table>
                        <thead>
                          <tr>
                            <th>When</th>
                            <th>Player</th>
                            <th>Requested</th>
                            <th>Method</th>
                          </tr>
                        </thead>
                        <tbody id="ci-dashboard-recent-cashouts-body">
                          <tr>
                            <td colspan="4" style="text-align:center;color:var(--text-muted);">
                              Waiting for data…
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- PLAYERS PANEL -->
            <section class="ci-admin-panel" data-panel="players" id="ci-panel-players">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Players</h2>
                  <div class="ci-panel-subtitle">
                    Player accounts, balances, KYC, risk, VIP &amp; self-exclusion.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" id="ci-players-refresh-btn">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="players">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-split">
                <div class="ci-split-main">
                  <div class="ci-toolbar">
                    <div class="ci-toolbar-left">
                      <div class="ci-toolbar-search-wrap">
                        <span class="ci-toolbar-search-icon"></span>
                        <input
                          type="search"
                          class="ci-input ci-toolbar-search"
                          id="ci-players-search"
                          placeholder="Search (Player ID, Username, Full Name, Email...)"
                          autocomplete="off"
                        />
                      </div>
                      <button type="button" class="ci-btn-ghost" id="ci-players-show-all">
                        Show All
                      </button>
                    </div>
                    <div class="ci-toolbar-right">
                      <label>
                        Page Size
                        <select class="ci-select" id="ci-players-page-size">
                          <option value="10">10</option>
                          <option value="25" selected>25</option>
                          <option value="50">50</option>
                          <option value="100">100</option>
                        </select>
                      </label>
                    </div>
                  </div>

                  <div class="ci-table-wrap">
                    <div class="ci-table-scroll">
                      <table class="ci-table" id="ci-players-table">
                        <thead>
                          <tr id="ci-players-thead-row">
                            <!-- Filled by JS -->
                          </tr>
                        </thead>
                        <tbody id="ci-players-tbody">
                          <!-- Filled by JS -->
                        </tbody>
                      </table>
                    </div>
                    <div class="ci-pagination" id="ci-players-pagination">
                      <div>
                        <button type="button" class="ci-btn-ghost" id="ci-players-prev-page">
                          ◀ Prev
                        </button>
                        <button type="button" class="ci-btn-ghost" id="ci-players-next-page">
                          Next ▶
                        </button>
                      </div>
                      <div id="ci-players-page-info">Page 1 of 1 • 0 players</div>
                    </div>
                  </div>
                </div>

                <aside class="ci-split-side" id="ci-players-detail">
                  <div class="ci-side-title">
                    <h3>Player Details &amp; Adjustments</h3>
                    <span class="ci-pill" id="ci-players-detail-pill">No player selected</span>
                  </div>

                  <div id="ci-players-detail-body">
                    <div class="ci-side-callout">
                      Select a player row from the table to view account details, change
                      KYC / risk / VIP, or comp / adjust chips and trigger manual cashouts.
                    </div>
                  </div>
                </aside>
              </div>
            </section>
            <!-- LOG PANEL -->
            <section class="ci-admin-panel" data-panel="log">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Log</h2>
                  <div class="ci-panel-subtitle">
                    Player signup, login, credit, cashout and blocked_* events from the Log sheet.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="log">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="log">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Full Name, Email, Event Type...)"
                      autocomplete="off"
                      data-grid-search="log"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="log">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="log">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="log"></tr>
                    </thead>
                    <tbody data-grid-body="log"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="log">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="log">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="log">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="log">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- GAME LEDGER PANEL -->
            <section class="ci-admin-panel" data-panel="gameLedger">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Game Ledger</h2>
                  <div class="ci-panel-subtitle">
                    Per-round game results, deltas, and balance snapshots.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="gameLedger">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="gameLedger">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Game Name, Event ID...)"
                      autocomplete="off"
                      data-grid-search="gameLedger"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="gameLedger">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="gameLedger">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="gameLedger"></tr>
                    </thead>
                    <tbody data-grid-body="gameLedger"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="gameLedger">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="gameLedger">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="gameLedger">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="gameLedger">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- REWARDS PANEL -->
            <section class="ci-admin-panel" data-panel="rewards">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Rewards</h2>
                  <div class="ci-panel-subtitle">
                    Reward claims, bonuses, and comps recorded in the Rewards sheet.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="rewards">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="rewards">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Reward Type, Notes...)"
                      autocomplete="off"
                      data-grid-search="rewards"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="rewards">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="rewards">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="rewards"></tr>
                    </thead>
                    <tbody data-grid-body="rewards"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="rewards">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="rewards">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="rewards">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="rewards">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- CASHOUTS PANEL -->
            <section class="ci-admin-panel" data-panel="cashouts">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Cashouts</h2>
                  <div class="ci-panel-subtitle">
                    Dedicated cashout log — requested chips, method, details.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="cashouts">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="cashouts">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Email, Method...)"
                      autocomplete="off"
                      data-grid-search="cashouts"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="cashouts">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="cashouts">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="cashouts"></tr>
                    </thead>
                    <tbody data-grid-body="cashouts"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="cashouts">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="cashouts">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="cashouts">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="cashouts">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- STRIPE LEDGER PANEL -->
            <section class="ci-admin-panel" data-panel="stripe">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Stripe Ledger</h2>
                  <div class="ci-panel-subtitle">
                    Stripe webhook log and chip credits.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="stripe">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="stripe">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Stripe Event ID, Player ID, Email...)"
                      autocomplete="off"
                      data-grid-search="stripe"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="stripe">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="stripe">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="stripe"></tr>
                    </thead>
                    <tbody data-grid-body="stripe"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="stripe">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="stripe">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="stripe">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="stripe">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- PAYPAL LEDGER PANEL -->
            <section class="ci-admin-panel" data-panel="paypal">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>PayPal Ledger</h2>
                  <div class="ci-panel-subtitle">
                    Cashier PayPal successes and chip credits.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="paypal">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="paypal">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (PayPal Txn, Player ID, Email...)"
                      autocomplete="off"
                      data-grid-search="paypal"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="paypal">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="paypal">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="paypal"></tr>
                    </thead>
                    <tbody data-grid-body="paypal"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="paypal">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="paypal">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="paypal">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="paypal">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- BLACKLIST PANEL -->
            <section class="ci-admin-panel" data-panel="blacklist">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Blacklist</h2>
                  <div class="ci-panel-subtitle">
                    Blocked / barred players and reasons.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="blacklist">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="blacklist">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Full Name, Email, Status...)"
                      autocomplete="off"
                      data-grid-search="blacklist"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="blacklist">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="blacklist">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="blacklist"></tr>
                    </thead>
                    <tbody data-grid-body="blacklist"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="blacklist">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="blacklist">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="blacklist">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="blacklist">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- REPORTS PANEL -->
            <section class="ci-admin-panel" data-panel="reports">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Reports</h2>
                  <div class="ci-panel-subtitle">
                    KPIs and snapshots from the Reports sheet.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" id="ci-reports-refresh-btn">
                    Rebuild &amp; Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="reports">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search within Reports sheet…"
                      autocomplete="off"
                      data-grid-search="reports"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="reports">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="reports">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="reports"></tr>
                    </thead>
                    <tbody data-grid-body="reports"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="reports">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="reports">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="reports">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="reports">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- ADMIN LOG PANEL -->
            <section class="ci-admin-panel" data-panel="adminLog">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Admin Log</h2>
                  <div class="ci-panel-subtitle">
                    System and admin actions recorded to the Admin Log sheet.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="adminLog">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="adminLog">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Action, Username, Details...)"
                      autocomplete="off"
                      data-grid-search="adminLog"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="adminLog">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="adminLog">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="adminLog"></tr>
                    </thead>
                    <tbody data-grid-body="adminLog"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="adminLog">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="adminLog">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="adminLog">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="adminLog">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>
          </div>
        </section>
      </main>

      <footer class="ci-admin-footer">
        FOR INTERNAL USE ONLY
      </footer>
    </div>
  </div>

  <div class="ci-admin-loading" id="ci-admin-loading-overlay">
    <div class="ci-admin-loading-inner">
      <div class="ci-spinner"></div>
      <div id="ci-admin-loading-text">Working…</div>
    </div>
  </div>
  <script>
    "use strict";

    // Web App URL (your current deployment)
    const CI_BACKEND_URL =
      "https://script.google.com/macros/s/AKfycbzTJ3121csJjqE3pcxYPCKT7tFgzZ68ZLn-ECBFzhrvzfx3EXZw09l3a5ePfSMwMdd2lg/exec";

    // Global state
    const ciState = {
      apiKey: null,
      adminUser: null,
      players: {
        list: [],
        filtered: [],
        page: 1,
        pageSize: 25,
        sortKey: "username",
        sortDir: "asc",
      },
      grids: {}, // sheet grids
      hasLoaded: {
        dashboard: false,
        players: false,
        log: false,
        gameLedger: false,
        adminLog: false,
        rewards: false,
        cashouts: false,
        reports: false,
        blacklist: false,
        stripe: false,
        paypal: false,
      },
    };

    function qs(sel, root) {
      return (root || document).querySelector(sel);
    }
    function qsa(sel, root) {
      return Array.from((root || document).querySelectorAll(sel));
    }

    function setStatus(message, isError) {
      const strip = qs("#ci-admin-status-strip");
      const text = qs("#ci-admin-status-text");
      if (!strip || !text) return;
      text.textContent = message || "";
      strip.classList.toggle("ci-admin-status-error", !!isError);
    }

    function setLoading(isLoading, label) {
      const overlay = qs("#ci-admin-loading-overlay");
      const text = qs("#ci-admin-loading-text");
      if (!overlay) return;
      if (text && label) text.textContent = label;
      overlay.style.display = isLoading ? "flex" : "none";
    }

    function setOnlineBadge(isOnline) {
      const badge = qs("#ci-admin-status-badge");
      if (!badge) return;
      if (isOnline) {
        badge.textContent = "Online";
        badge.classList.add("ci-badge-online");
      } else {
        badge.textContent = "Offline";
        badge.classList.remove("ci-badge-online");
      }
    }

    function formatNumber(num) {
      const n = Number(num);
      if (isNaN(n)) return "0";
      return n.toLocaleString("en-US");
    }

    function formatChips(num) {
      const n = Number(num);
      if (isNaN(n)) return "0";
      return n.toLocaleString("en-US") + " chips";
    }

    function trimString(value, maxLength) {
      const s = String(value == null ? "" : value);
      if (!maxLength || s.length <= maxLength) return s;
      return s.slice(0, maxLength - 1) + "…";
    }

    // Fetch helpers
    async function postJson(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        body: JSON.stringify(payload || {}),
      });

      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error("Backend Error:", text);
        throw new Error("Invalid JSON from backend");
      }
    }

    async function getJson(url) {
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json",
        },
      });
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error("Invalid JSON from backend");
      }
    }

    // Admin GET API wrapper
    async function adminGet(action, extraParams) {
      if (!ciState.apiKey) {
        throw new Error("Admin API key missing");
      }
      const params = Object.assign({}, extraParams || {}, {
        mode: "admin_api",
        action: action,
        apiKey: ciState.apiKey,
      });

      const usp = new URLSearchParams();
      Object.keys(params).forEach(function (key) {
        if (params[key] == null) return;
        usp.append(key, String(params[key]));
      });

      const url = CI_BACKEND_URL + "?" + usp.toString();
      return getJson(url);
    }

    // Helper: load Players from the Players sheet via getSheet
    async function fetchPlayersFromSheet(maxRows) {
      if (!ciState.apiKey) {
        throw new Error("Admin API key missing");
      }

      const res = await adminGet("getSheet", {
        sheetName: "Players",
        maxRows: maxRows || 2000,
      });

      if (!res || !res.ok) {
        throw new Error((res && res.error) || "Failed to load Players sheet");
      }

      const headers = res.headers || [];
      const rows = res.rows || [];

      const idxPlayerId = headers.indexOf("Player ID");
      const idxUsername = headers.indexOf("Username");
      const idxFullName = headers.indexOf("Full Name");
      const idxEmail = headers.indexOf("Email");
      const idxBalance = headers.indexOf("Current Balance");
      const idxKycStatus = headers.indexOf("KYC Status");
      const idxRiskStatus = headers.indexOf("Risk Status");
      const idxVipLevel = headers.indexOf("VIP Level");
      const idxFlagNotes = headers.indexOf("Flag Notes");

      let idxSelfUntil = headers.indexOf("Self Excluded Until");
      if (idxSelfUntil < 0) {
        idxSelfUntil = headers.indexOf("Self-Excluded Until");
      }
      const idxSelfReason = headers.indexOf("Self Exclusion Reason");
      const idxSelfActive = headers.indexOf("Self Exclusion Active");

      const players = rows
        .map(function (row) {
          const player = {
            playerId: idxPlayerId >= 0 ? row[idxPlayerId] : "",
            username: idxUsername >= 0 ? row[idxUsername] : "",
            fullName: idxFullName >= 0 ? row[idxFullName] : "",
            email: idxEmail >= 0 ? row[idxEmail] : "",
            balance:
              idxBalance >= 0 && row[idxBalance] != null && row[idxBalance] !== ""
                ? Number(row[idxBalance]) || 0
                : 0,
            kycStatus: idxKycStatus >= 0 ? row[idxKycStatus] : "",
            riskStatus: idxRiskStatus >= 0 ? row[idxRiskStatus] : "",
            vipLevel: idxVipLevel >= 0 ? row[idxVipLevel] : "",
            flagNotes: idxFlagNotes >= 0 ? row[idxFlagNotes] : "",
            selfExcludedUntil: idxSelfUntil >= 0 ? row[idxSelfUntil] : "",
            selfExclusionReason: idxSelfReason >= 0 ? row[idxSelfReason] : "",
            selfExclusionActive: idxSelfActive >= 0 ? row[idxSelfActive] : "",
          };

          if (!player.playerId && !player.username && !player.email) {
            return null;
          }
          return player;
        })
        .filter(function (p) {
          return !!p;
        });

      return players;
    }

    // Login
    async function handleAdminLogin(event) {
      event.preventDefault();
      const usernameEl = qs("#ci-admin-username");
      const passwordEl = qs("#ci-admin-password");
      if (!usernameEl || !passwordEl) return;

      const username = usernameEl.value.trim();
      const password = passwordEl.value;
      if (!username || !password) {
        setStatus("Enter both username and password.", true);
        return;
      }

      setLoading(true, "Signing in…");
      setStatus("Signing in to Admin Portal…", false);

      try {
        const payload = {
          mode: "admin_login",
          username: username,
          password: password,
        };
        const data = await postJson(CI_BACKEND_URL, payload);

        if (!data || !data.ok || !data.apiKey) {
          setStatus("Invalid credentials or admin login failed.", true);
          setOnlineBadge(false);
          setLoading(false);
          return;
        }

        ciState.apiKey = data.apiKey;
        ciState.adminUser = username;

        setOnlineBadge(true);
        setStatus("Admin Portal unlocked. Use the tabs to navigate.", false);

        const loginView = qs("#ci-admin-login-view");
        const appView = qs("#ci-admin-app-view");
        if (loginView) loginView.style.display = "none";
        if (appView) appView.style.display = "flex";

        const webAppLabel = qs("#ci-admin-webapp-label");
        if (webAppLabel) {
          webAppLabel.textContent = "Connected";
        }

        // Auto-switch to Dashboard
        activateTab("dashboard");
        await loadDashboard();
      } catch (err) {
        setStatus("Login error: " + String(err.message || err), true);
        setOnlineBadge(false);
      } finally {
        setLoading(false);
      }
    }

    function resetLoginForm() {
      const usernameEl = qs("#ci-admin-username");
      const passwordEl = qs("#ci-admin-password");
      if (usernameEl) usernameEl.value = "";
      if (passwordEl) passwordEl.value = "";
      setStatus("Enter your admin credentials to unlock the portal.", false);
    }

    // Tab handling
    function activateTab(panelName) {
      const tabs = qsa(".ci-admin-tab");
      tabs.forEach(function (btn) {
        const name = btn.getAttribute("data-tab");
        const active = name === panelName;
        btn.classList.toggle("ci-admin-tab-active", active);
      });

      const panels = qsa(".ci-admin-panel");
      panels.forEach(function (panel) {
        const name = panel.getAttribute("data-panel");
        const active = name === panelName;
        panel.classList.toggle("ci-admin-panel-active", active);
      });

      if (!ciState.hasLoaded[panelName]) {
        ciState.hasLoaded[panelName] = true;
        if (panelName === "players") {
          loadPlayers();
        } else if (panelName === "log") {
          loadSheetGrid("log", "Log", 500);
        } else if (panelName === "gameLedger") {
          loadSheetGrid("gameLedger", "Game Ledger", 500);
        } else if (panelName === "rewards") {
          loadSheetGrid("rewards", "Rewards", 500);
        } else if (panelName === "cashouts") {
          loadSheetGrid("cashouts", "Cashouts", 500);
        } else if (panelName === "stripe") {
          loadSheetGrid("stripe", "Stripe Ledger", 500);
        } else if (panelName === "paypal") {
          loadSheetGrid("paypal", "PayPal Ledger", 500);
        } else if (panelName === "blacklist") {
          loadSheetGrid("blacklist", "Blacklist", 500);
        } else if (panelName === "reports") {
          loadReports();
        } else if (panelName === "adminLog") {
          loadSheetGrid("adminLog", "Admin Log", 500);
        } else if (panelName === "dashboard") {
          loadDashboard();
        }
      }
    }

    // DASHBOARD (uses getSheet for Players + Cashouts)
    async function loadDashboard() {
      if (!ciState.apiKey) return;

      setLoading(true, "Refreshing dashboard…");
      setStatus("Refreshing dashboard metrics…", false);

      try {
        // Players from Players sheet
        const players = await fetchPlayersFromSheet(2000);
        const totalPlayers = players.length;

        let totalBalance = 0;
        const vipCounts = {};
        const topPlayers = [];
        let highRiskCount = 0;

        players.forEach(function (p) {
          const balance = Number(p.balance || 0);
          if (!isNaN(balance)) {
            totalBalance += balance;
            if (balance > 0) {
              topPlayers.push({
                playerId: p.playerId || "",
                username: p.username || "",
                vipLevel: p.vipLevel || "",
                balance: balance,
              });
            }
          }

          const vip = (p.vipLevel || "").toString() || "None";
          vipCounts[vip] = (vipCounts[vip] || 0) + 1;

          const risk = (p.riskStatus || "").toString().toLowerCase();
          if (risk === "high") {
            highRiskCount++;
          }
        });

        topPlayers.sort(function (a, b) {
          return b.balance - a.balance;
        });

        // Cashouts from Cashouts sheet
        const cashRes = await adminGet("getSheet", {
          sheetName: "Cashouts",
          maxRows: 200,
        });

        if (!cashRes || !cashRes.ok) {
          throw new Error(
            (cashRes && cashRes.error) || "Failed to load Cashouts sheet"
          );
        }

        const cashHeaders = cashRes.headers || [];
        const cashRows = cashRes.rows || [];

        const idxTs = cashHeaders.indexOf("Timestamp");
        const idxPid = cashHeaders.indexOf("Player ID");
        const idxUser = cashHeaders.indexOf("Username");
        const idxEmail = cashHeaders.indexOf("Email");
        const idxReq = cashHeaders.indexOf("Requested Chips");
        const idxUsd = cashHeaders.indexOf("USD Equivalent");
        const idxMethod = cashHeaders.indexOf("Payout Method");

        // KPI cards
        const elTotalPlayers = qs("#ci-kpi-total-players");
        const elTotalBalance = qs("#ci-kpi-total-balance");
        const elOpenCashouts = qs("#ci-kpi-open-cashouts");
        const elHighRisk = qs("#ci-kpi-high-risk");

        if (elTotalPlayers) elTotalPlayers.textContent = formatNumber(totalPlayers);
        if (elTotalBalance) elTotalBalance.textContent = formatChips(totalBalance);
        if (elHighRisk) elHighRisk.textContent = formatNumber(highRiskCount);

        const openCashouts = cashRows.length;
        if (elOpenCashouts) elOpenCashouts.textContent = formatNumber(openCashouts);

        // VIP snapshot
        const vipList = qs("#ci-dashboard-vip-list");
        if (vipList) {
          vipList.innerHTML = "";
          const vipKeys = Object.keys(vipCounts);
          if (!vipKeys.length) {
            const li = document.createElement("li");
            li.textContent = "No VIP levels recorded yet.";
            vipList.appendChild(li);
          } else {
            vipKeys.sort();
            vipKeys.forEach(function (vip) {
              const li = document.createElement("li");
              li.textContent =
                vip + ": " + formatNumber(vipCounts[vip]) + " players";
              vipList.appendChild(li);
            });
          }
        }

        // Top players by balance
        const topBody = qs("#ci-dashboard-top-players-body");
        if (topBody) {
          topBody.innerHTML = "";
          const maxTop = Math.min(10, topPlayers.length);
          if (maxTop === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 3;
            td.style.textAlign = "center";
            td.style.color = "var(--text-muted)";
            td.textContent = "No positive balances yet.";
            tr.appendChild(td);
            topBody.appendChild(tr);
          } else {
            for (let i = 0; i < maxTop; i++) {
              const p = topPlayers[i];
              const tr = document.createElement("tr");

              const tdName = document.createElement("td");
              tdName.textContent = trimString(
                p.username || p.playerId || "(Player)",
                24
              );

              const tdVip = document.createElement("td");
              tdVip.textContent = p.vipLevel || "—";

              const tdBal = document.createElement("td");
              tdBal.textContent = formatNumber(p.balance);

              tr.appendChild(tdName);
              tr.appendChild(tdVip);
              tr.appendChild(tdBal);
              topBody.appendChild(tr);
            }
          }
        }

        // Recent cashouts table
        const cashBody = qs("#ci-dashboard-recent-cashouts-body");
        if (cashBody) {
          cashBody.innerHTML = "";
          const maxRows = Math.min(10, cashRows.length);
          if (!maxRows) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 4;
            td.style.textAlign = "center";
            td.style.color = "var(--text-muted)";
            td.textContent = "No recent cashouts.";
            tr.appendChild(td);
            cashBody.appendChild(tr);
          } else {
            for (let i = 0; i < maxRows; i++) {
              const row = cashRows[cashRows.length - 1 - i];
              const tr = document.createElement("tr");

              const tsVal = idxTs >= 0 ? row[idxTs] : "";
              const pidVal = idxPid >= 0 ? row[idxPid] : "";
              const userVal = idxUser >= 0 ? row[idxUser] : "";
              const emailVal = idxEmail >= 0 ? row[idxEmail] : "";
              const reqVal = idxReq >= 0 ? row[idxReq] : "";
              const usdVal = idxUsd >= 0 ? row[idxUsd] : "";
              const methodVal = idxMethod >= 0 ? row[idxMethod] : "";

              const playerLabel =
                (userVal || "").toString() ||
                (pidVal || "").toString() ||
                (emailVal || "").toString();

              const tdTs = document.createElement("td");
              tdTs.textContent = tsVal ? new Date(tsVal).toLocaleString() : "—";

              const tdPlayer = document.createElement("td");
              tdPlayer.textContent = trimString(playerLabel, 28);

              const tdReq = document.createElement("td");
              if (usdVal !== null && usdVal !== undefined && usdVal !== "") {
                const n = Number(usdVal);
                tdReq.textContent = isNaN(n)
                  ? "$" + String(usdVal)
                  : "$" +
                    n.toLocaleString("en-US", {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2,
                    });
              } else {
                tdReq.textContent = formatNumber(reqVal);
              }

              const tdMethod = document.createElement("td");
              tdMethod.textContent = trimString(methodVal || "—", 18);

              tr.appendChild(tdTs);
              tr.appendChild(tdPlayer);
              tr.appendChild(tdReq);
              tr.appendChild(tdMethod);
              cashBody.appendChild(tr);
            }
          }
        }

        setStatus("House Dashboard", false);
      } catch (err) {
        setStatus("Dashboard refresh failed: " + String(err.message || err), true);
      } finally {
        setLoading(false);
      }
    }

    // SHEET GRID HANDLING (Log, Game Ledger, Rewards, Cashouts, Stripe, PayPal, Blacklist, Reports, Admin Log)
    function createSheetGrid(name, options) {
      return {
        name: name,
        headers: [],
        rows: [],
        rowNumbers: [],
        filteredIndexes: [],
        page: 1,
        pageSize: (options && options.pageSize) || 25,
        sortIndex: 0,
        sortDir: "desc",
        maxRows: (options && options.maxRows) || 500,
      };
    }

    function initSheetGrids() {
      ciState.grids.log = createSheetGrid("log", { pageSize: 25, maxRows: 500 });
      ciState.grids.gameLedger = createSheetGrid("gameLedger", {
        pageSize: 25,
        maxRows: 500,
      });
      ciState.grids.rewards = createSheetGrid("rewards", {
        pageSize: 25,
        maxRows: 500,
      });
      ciState.grids.cashouts = createSheetGrid("cashouts", {
        pageSize: 25,
        maxRows: 500,
      });
      ciState.grids.stripe = createSheetGrid("stripe", {
        pageSize: 25,
        maxRows: 500,
      });
      ciState.grids.paypal = createSheetGrid("paypal", {
        pageSize: 25,
        maxRows: 500,
      });
      ciState.grids.blacklist = createSheetGrid("blacklist", {
        pageSize: 25,
        maxRows: 500,
      });
      ciState.grids.reports = createSheetGrid("reports", {
        pageSize: 25,
        maxRows: 500,
      });
      ciState.grids.adminLog = createSheetGrid("adminLog", {
        pageSize: 25,
        maxRows: 500,
      });
    }

    function getSheetNameForGrid(gridName) {
      switch (gridName) {
        case "log":
          return "Log";
        case "gameLedger":
          return "Game Ledger";
        case "rewards":
          return "Rewards";
        case "cashouts":
          return "Cashouts";
        case "stripe":
          return "Stripe Ledger";
        case "paypal":
          return "PayPal Ledger";
        case "blacklist":
          return "Blacklist";
        case "reports":
          return "Reports";
        case "adminLog":
          return "Admin Log";
        default:
          return "";
      }
    }

    async function loadSheetGrid(gridName, sheetNameOverride, maxRowsOverride) {
      const grid = ciState.grids[gridName];
      if (!grid) return;
      const sheetName = sheetNameOverride || getSheetNameForGrid(gridName);
      if (!sheetName) return;

      const maxRows = maxRowsOverride || grid.maxRows;

      setLoading(true, "Loading " + sheetName + "…");
      setStatus("Loading " + sheetName + "…", false);

      try {
        const res = await adminGet("getSheet", {
          sheetName: sheetName,
          maxRows: maxRows,
        });

        if (!res || !res.ok) {
          throw new Error((res && res.error) || "Unknown error");
        }

        grid.headers = res.headers || [];
        grid.rows = res.rows || [];
        grid.rowNumbers = Array.isArray(res.rowNumbers) ? res.rowNumbers : [];

        grid.sortIndex = 0;
        grid.sortDir = "desc";
        grid.page = 1;

        applyGridFilterAndRender(gridName);
        setStatus(sheetName + " updated.", false);
      } catch (err) {
        setStatus(
          "Failed to load " + sheetName + ": " + String(err.message || err),
          true
        );
      } finally {
        setLoading(false);
      }
    }

    function applyGridFilterAndRender(gridName) {
      const grid = ciState.grids[gridName];
      if (!grid) return;

      const searchInput = qs('[data-grid-search="' + gridName + '"]');
      const searchTerm = searchInput
        ? searchInput.value.trim().toLowerCase()
        : "";

      const rows = grid.rows || [];
      const indexes = [];

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!searchTerm) {
          indexes.push(i);
          continue;
        }
        let match = false;
        for (let c = 0; c < row.length; c++) {
          const cell = row[c];
          if (cell == null) continue;
          const s = String(cell).toLowerCase();
          if (!s) continue;
          if (s.indexOf(searchTerm) !== -1) {
            match = true;
            break;
          }
        }
        if (match) indexes.push(i);
      }

      grid.filteredIndexes = indexes;

      const totalPages = Math.max(
        1,
        Math.ceil(indexes.length / grid.pageSize || 1)
      );
      if (grid.page > totalPages) grid.page = totalPages;
      if (grid.page < 1) grid.page = 1;

      const si = grid.sortIndex;
      const dir = grid.sortDir === "asc" ? 1 : -1;
      grid.filteredIndexes.sort(function (aIdx, bIdx) {
        const aRow = rows[aIdx] || [];
        const bRow = rows[bIdx] || [];
        const aVal = aRow[si];
        const bVal = bRow[si];

        const aNum = Number(aVal);
        const bNum = Number(bVal);
        let cmp;
        if (!isNaN(aNum) && !isNaN(bNum)) {
          cmp = aNum - bNum;
        } else {
          const aStr =
            aVal == null ? "" : String(aVal).toLowerCase().trim();
          const bStr =
            bVal == null ? "" : String(bVal).toLowerCase().trim();
          cmp = aStr < bStr ? -1 : aStr > bStr ? 1 : 0;
        }
        return cmp * dir;
      });

      renderGrid(gridName);
    }

    function renderGrid(gridName) {
      const grid = ciState.grids[gridName];
      if (!grid) return;

      const headRow = qs('[data-grid-head="' + gridName + '"]');
      const bodyEl = qs('[data-grid-body="' + gridName + '"]');
      const pageInfoEl = qs(
        '[data-grid-page-info="' + gridName + '"]'
      );

      if (!headRow || !bodyEl || !pageInfoEl) return;

      const headers = grid.headers || [];
      const rows = grid.rows || [];
      const indexes = grid.filteredIndexes || [];

      headRow.innerHTML = "";
      headers.forEach(function (header, idx) {
        const th = document.createElement("th");
        th.textContent = header || "";
        th.dataset.index = String(idx);
        th.dataset.sortable = "true";

        if (idx === grid.sortIndex) {
          const span = document.createElement("span");
          span.className = "ci-sort-indicator";
          span.textContent = grid.sortDir === "asc" ? "▲" : "▼";
          th.appendChild(span);
        }

        headRow.appendChild(th);
      });

      const pageSize = grid.pageSize;
      const totalRows = indexes.length;
      const totalPages = Math.max(
        1,
        Math.ceil(totalRows / (pageSize || 1))
      );
      const currentPage = Math.min(Math.max(grid.page, 1), totalPages);
      grid.page = currentPage;

      const start = (currentPage - 1) * pageSize;
      const end = Math.min(start + pageSize, totalRows);

      bodyEl.innerHTML = "";

      if (!totalRows) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = Math.max(headers.length, 1);
        td.style.textAlign = "center";
        td.style.color = "var(--text-muted)";
        td.textContent = "No rows to display.";
        tr.appendChild(td);
        bodyEl.appendChild(tr);
      } else {
        for (let i = start; i < end; i++) {
          const rowIdx = indexes[i];
          const row = rows[rowIdx] || [];
          const tr = document.createElement("tr");

          row.forEach(function (cell, colIdx) {
            const td = document.createElement("td");

            if (gridName === "rewards") {
              const headerLabel =
                headers[colIdx] == null ? "" : String(headers[colIdx]);
              if (headerLabel.toLowerCase() === "status") {
                const valueStr = cell == null ? "" : String(cell);
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "ci-link-button";
                btn.textContent = valueStr || "(set)";
                btn.setAttribute("data-status-edit", "rewards");
                btn.setAttribute("data-row-idx", String(rowIdx));
                btn.setAttribute("data-status-value", valueStr);
                td.appendChild(btn);
              } else {
                td.textContent = cell == null ? "" : String(cell);
              }
            } else {
              td.textContent = cell == null ? "" : String(cell);
            }

            tr.appendChild(td);
          });

          bodyEl.appendChild(tr);
        }
      }

      pageInfoEl.textContent =
        "Page " +
        currentPage +
        " of " +
        totalPages +
        " • " +
        formatNumber(totalRows) +
        " rows";
    }

    function handleGridSortClick(event) {
      const th = event.target.closest("th");
      if (!th || !th.dataset || !th.dataset.index) return;

      const headRow = th.parentElement;
      if (!headRow) return;

      const gridNames = [
        "log",
        "gameLedger",
        "rewards",
        "cashouts",
        "stripe",
        "paypal",
        "blacklist",
        "reports",
        "adminLog",
      ];
      let gridName = null;
      for (let i = 0; i < gridNames.length; i++) {
        const name = gridNames[i];
        if (headRow.matches('[data-grid-head="' + name + '"]')) {
          gridName = name;
          break;
        }
      }
      if (!gridName) return;

      const grid = ciState.grids[gridName];
      if (!grid) return;

      const idx = Number(th.dataset.index);
      if (isNaN(idx)) return;

      if (grid.sortIndex === idx) {
        grid.sortDir = grid.sortDir === "asc" ? "desc" : "asc";
      } else {
        grid.sortIndex = idx;
        grid.sortDir = "asc";
      }

      applyGridFilterAndRender(gridName);
    }

    function attachGridDomHandlers() {
      qsa("tr[data-grid-head]").forEach(function (headRow) {
        headRow.addEventListener("click", handleGridSortClick);
      });

      qsa("[data-grid-search]").forEach(function (input) {
        const gridName = input.getAttribute("data-grid-search");
        input.addEventListener("input", function () {
          const grid = ciState.grids[gridName];
          if (!grid) return;
          grid.page = 1;
          applyGridFilterAndRender(gridName);
        });
      });

      qsa("[data-grid-show-all]").forEach(function (btn) {
        const gridName = btn.getAttribute("data-grid-show-all");
        btn.addEventListener("click", function () {
          const input = qs('[data-grid-search="' + gridName + '"]');
          if (input) input.value = "";
          const grid = ciState.grids[gridName];
          if (!grid) return;
          grid.page = 1;
          applyGridFilterAndRender(gridName);
        });
      });

      qsa("[data-grid-page-size]").forEach(function (sel) {
        const gridName = sel.getAttribute("data-grid-page-size");
        sel.addEventListener("change", function () {
          const grid = ciState.grids[gridName];
          if (!grid) return;
          const val = Number(sel.value);
          if (!isNaN(val) && val > 0) {
            grid.pageSize = val;
            grid.page = 1;
            applyGridFilterAndRender(gridName);
          }
        });
      });

      qsa("[data-grid-prev]").forEach(function (btn) {
        const gridName = btn.getAttribute("data-grid-prev");
        btn.addEventListener("click", function () {
          const grid = ciState.grids[gridName];
          if (!grid) return;
          grid.page = Math.max(1, grid.page - 1);
          applyGridFilterAndRender(gridName);
        });
      });

      qsa("[data-grid-next]").forEach(function (btn) {
        const gridName = btn.getAttribute("data-grid-next");
        btn.addEventListener("click", function () {
          const grid = ciState.grids[gridName];
          if (!grid) return;
          const total = grid.filteredIndexes.length;
          const totalPages = Math.max(
            1,
            Math.ceil(total / (grid.pageSize || 1))
          );
          grid.page = Math.min(totalPages, grid.page + 1);
          applyGridFilterAndRender(gridName);
        });
      });

      qsa("[data-grid-refresh]").forEach(function (btn) {
        const gridName = btn.getAttribute("data-grid-refresh");
        btn.addEventListener("click", function () {
          const sheet = getSheetNameForGrid(gridName);
          loadSheetGrid(gridName, sheet, 500);
        });
      });

      qsa("[data-grid-print]").forEach(function (btn) {
        const target = btn.getAttribute("data-grid-print");
        btn.addEventListener("click", function () {
          window.print();
        });
      });

      const dashboardPrintBtn = qsa('[data-grid-print="dashboard"]')[0];
      if (dashboardPrintBtn) {
        dashboardPrintBtn.addEventListener("click", function () {
          window.print();
        });
      }

      const rewardsBody = qs('[data-grid-body="rewards"]');
      if (rewardsBody) {
        rewardsBody.addEventListener("click", function (event) {
          const btn = event.target.closest("[data-status-edit]");
          if (!btn) return;
          const rowIdxAttr = btn.getAttribute("data-row-idx");
          if (!rowIdxAttr) return;
          const rowIdx = Number(rowIdxAttr);
          if (isNaN(rowIdx)) return;
          const currentValue =
            btn.getAttribute("data-status-value") || btn.textContent || "";
          const newStatus = window.prompt(
            "Update Rewards Status:",
            currentValue
          );
          if (newStatus === null) return;
          updateRewardsStatus(rowIdx, newStatus);
        });
      }
    }

    async function updateRewardsStatus(rowIdx, newStatus) {
      const grid = ciState.grids.rewards;
      if (!grid) return;
      if (!ciState.apiKey) {
        setStatus("Admin API key missing. Please log in again.", true);
        return;
      }

      const rowNumbers = grid.rowNumbers || [];
      const rowNumber = rowNumbers[rowIdx];
      if (!rowNumber) {
        setStatus(
          "Cannot update Rewards status: row mapping not available.",
          true
        );
        return;
      }

      const statusColIndex = grid.headers
        ? grid.headers.findIndex(function (h) {
            return (
              (h || "").toString().toLowerCase().trim() === "status"
            );
          })
        : -1;

      setLoading(true, "Updating reward status…");
      setStatus("Updating reward status…", false);

      try {
        const sheetName = getSheetNameForGrid("rewards") || "Rewards";
        const res = await adminGet("updateCellStatus", {
          sheetName: sheetName,
          rowNumbers: String(rowNumber),
          status: newStatus,
        });

        if (!res || !res.ok) {
          throw new Error((res && res.error) || "Unknown error");
        }

        if (statusColIndex >= 0 && grid.rows[rowIdx]) {
          grid.rows[rowIdx][statusColIndex] = newStatus;
        }

        applyGridFilterAndRender("rewards");
        setStatus("Reward status updated.", false);
      } catch (err) {
        setStatus(
          "Failed to update reward status: " + String(err.message || err),
          true
        );
      } finally {
        setLoading(false);
      }
    }

    // PLAYERS TAB — search, sort, pagination, KYC, comp/adjust, manual cashout
    function initPlayersDomHandlers() {
      const searchInput = qs("#ci-players-search");
      const showAllBtn = qs("#ci-players-show-all");
      const pageSizeSel = qs("#ci-players-page-size");
      const prevBtn = qs("#ci-players-prev-page");
      const nextBtn = qs("#ci-players-next-page");
      const refreshBtn = qs("#ci-players-refresh-btn");
      const tableBody = qs("#ci-players-tbody");

      if (searchInput) {
        searchInput.addEventListener("input", function () {
          ciState.players.page = 1;
          applyPlayersFilterAndRender();
        });
      }

      if (showAllBtn) {
        showAllBtn.addEventListener("click", function () {
          if (searchInput) searchInput.value = "";
          ciState.players.page = 1;
          applyPlayersFilterAndRender();
        });
      }

      if (pageSizeSel) {
        pageSizeSel.addEventListener("change", function () {
          const val = Number(pageSizeSel.value);
          if (!isNaN(val) && val > 0) {
            ciState.players.pageSize = val;
            ciState.players.page = 1;
            applyPlayersFilterAndRender();
          }
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener("click", function () {
          ciState.players.page = Math.max(1, ciState.players.page - 1);
          applyPlayersFilterAndRender();
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", function () {
          const total = ciState.players.filtered.length;
          const pageSize = ciState.players.pageSize;
          const totalPages = Math.max(
            1,
            Math.ceil(total / (pageSize || 1))
          );
          ciState.players.page = Math.min(
            totalPages,
            ciState.players.page + 1
          );
          applyPlayersFilterAndRender();
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener("click", function () {
          loadPlayers();
        });
      }

      if (tableBody) {
        tableBody.addEventListener("click", function (event) {
          const row = event.target.closest("tr");
          if (!row) return;
          const idxAttr = row.getAttribute("data-player-index");
          if (!idxAttr) return;
          const idx = Number(idxAttr);
          if (isNaN(idx)) return;

          const player = ciState.players.filtered[idx];
          if (player) {
            selectPlayerRow(idx);
            renderPlayerDetail(player);
          }
        });
      }

      const theadRow = qs("#ci-players-thead-row");
      if (theadRow) {
        theadRow.addEventListener("click", function (event) {
          const th = event.target.closest("th");
          if (!th || !th.dataset.sortKey) return;
          const sortKey = th.dataset.sortKey;
          if (ciState.players.sortKey === sortKey) {
            ciState.players.sortDir =
              ciState.players.sortDir === "asc" ? "desc" : "asc";
          } else {
            ciState.players.sortKey = sortKey;
            ciState.players.sortDir = "asc";
          }
          applyPlayersFilterAndRender();
        });
      }
    }

    // loadPlayers uses fetchPlayersFromSheet (no listPlayers action)
    async function loadPlayers() {
      if (!ciState.apiKey) return;
      setLoading(true, "Loading Players…");
      setStatus("Loading Players…", false);

      try {
        const players = await fetchPlayersFromSheet(2000);

        ciState.players.list = players;
        ciState.players.page = 1;
        ciState.players.sortKey = "username";
        ciState.players.sortDir = "asc";

        renderPlayersHeader();
        applyPlayersFilterAndRender();

        setStatus("Players list refreshed from Players sheet.", false);
      } catch (err) {
        setStatus("Failed to load players: " + String(err.message || err), true);
      } finally {
        setLoading(false);
      }
    }

    function renderPlayersHeader() {
      const theadRow = qs("#ci-players-thead-row");
      if (!theadRow) return;
      theadRow.innerHTML = "";

      const headers = [
        { label: "Player ID", key: "playerId" },
        { label: "Username", key: "username" },
        { label: "Full Name", key: "fullName" },
        { label: "Email", key: "email" },
        { label: "Current Balance", key: "balance" },
      ];

      headers.forEach(function (h) {
        const th = document.createElement("th");
        th.textContent = h.label;
        th.dataset.sortKey = h.key;

        if (ciState.players.sortKey === h.key) {
          const span = document.createElement("span");
          span.className = "ci-sort-indicator";
          span.textContent =
            ciState.players.sortDir === "asc" ? "▲" : "▼";
          th.appendChild(span);
        }

        theadRow.appendChild(th);
      });
    }

    function applyPlayersFilterAndRender() {
      const searchInput = qs("#ci-players-search");
      const searchTerm = searchInput
        ? searchInput.value.trim().toLowerCase()
        : "";

      const list = ciState.players.list || [];
      const filtered = [];

      list.forEach(function (p) {
        const pid = (p.playerId || "").toString().toLowerCase();
        const user = (p.username || "").toString().toLowerCase();
        const name = (p.fullName || "").toString().toLowerCase();
        const email = (p.email || "").toString().toLowerCase();
        const balStr = (p.balance == null
          ? ""
          : String(p.balance)
        ).toLowerCase();

        if (!searchTerm) {
          filtered.push(p);
        } else {
          if (
            pid.indexOf(searchTerm) !== -1 ||
            user.indexOf(searchTerm) !== -1 ||
            name.indexOf(searchTerm) !== -1 ||
            email.indexOf(searchTerm) !== -1 ||
            balStr.indexOf(searchTerm) !== -1
          ) {
            filtered.push(p);
          }
        }
      });

      const sortKey = ciState.players.sortKey;
      const dir = ciState.players.sortDir === "asc" ? 1 : -1;

      filtered.sort(function (a, b) {
        const av = a[sortKey];
        const bv = b[sortKey];

        if (sortKey === "balance") {
          const an = Number(av || 0);
          const bn = Number(bv || 0);
          return (an - bn) * dir;
        }

        const aStr = (av == null ? "" : String(av)).toLowerCase();
        const bStr = (bv == null ? "" : String(bv)).toLowerCase();
        if (aStr < bStr) return -1 * dir;
        if (aStr > bStr) return 1 * dir;
        return 0;
      });

      ciState.players.filtered = filtered;

      const pageSize = ciState.players.pageSize;
      const total = filtered.length;
      const totalPages = Math.max(
        1,
        Math.ceil(total / (pageSize || 1))
      );
      if (ciState.players.page > totalPages)
        ciState.players.page = totalPages;
      if (ciState.players.page < 1) ciState.players.page = 1;

      renderPlayersTable();
    }

    function renderPlayersTable() {
      const tbody = qs("#ci-players-tbody");
      const pageInfo = qs("#ci-players-page-info");
      if (!tbody || !pageInfo) return;

      const filtered = ciState.players.filtered || [];
      const page = ciState.players.page;
      const pageSize = ciState.players.pageSize;
      const total = filtered.length;

      const totalPages = Math.max(
        1,
        Math.ceil(total / (pageSize || 1))
      );
      const start = (page - 1) * pageSize;
      const end = Math.min(start + pageSize, total);

      tbody.innerHTML = "";

      if (!total) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.style.textAlign = "center";
        td.style.color = "var(--text-muted)";
        td.textContent = "No players found.";
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        for (let i = start; i < end; i++) {
          const p = filtered[i];
          const tr = document.createElement("tr");
          tr.setAttribute("data-player-index", String(i));

          const pid = document.createElement("td");
          pid.textContent = p.playerId || "";
          tr.appendChild(pid);

          const user = document.createElement("td");
          user.textContent = p.username || "";
          tr.appendChild(user);

          const fullName = document.createElement("td");
          fullName.textContent = p.fullName || "";
          tr.appendChild(fullName);

          const email = document.createElement("td");
          email.textContent = p.email || "";
          tr.appendChild(email);

          const bal = document.createElement("td");
          bal.textContent = formatNumber(p.balance || 0);
          bal.style.textAlign = "right";
          tr.appendChild(bal);

          tbody.appendChild(tr);
        }
      }

      pageInfo.textContent =
        "Page " +
        page +
        " of " +
        totalPages +
        " • " +
        formatNumber(total) +
        " players";

      qsa("#ci-players-tbody tr").forEach(function (row) {
        row.classList.remove("ci-table-row-selected");
      });
    }

    function selectPlayerRow(filteredIndex) {
      qsa("#ci-players-tbody tr").forEach(function (row) {
        row.classList.remove("ci-table-row-selected");
      });

      const row = qs(
        '#ci-players-tbody tr[data-player-index="' +
          String(filteredIndex) +
          '"]'
      );
      if (row) row.classList.add("ci-table-row-selected");

      const pill = qs("#ci-players-detail-pill");
      if (pill) pill.textContent = "Player selected";
    }

    function buildPlayerDetailHtml(player) {
      const balanceLabel = formatChips(player.balance || 0);

      const headerHtml =
        '<div class="ci-side-section">' +
        '  <h4>Account</h4>' +
        '  <div class="ci-side-row"><span class="ci-side-label">Player ID</span><span class="ci-side-value ci-mono">' +
        (player.playerId || "—") +
        "</span></div>" +
        '  <div class="ci-side-row"><span class="ci-side-label">Username</span><span class="ci-side-value ci-mono">' +
        (player.username || "—") +
        "</span></div>" +
        '  <div class="ci-side-row"><span class="ci-side-label">Full Name</span><span class="ci-side-value">' +
        (player.fullName || "—") +
        "</span></div>" +
        '  <div class="ci-side-row"><span class="ci-side-label">Email</span><span class="ci-side-value ci-mono">' +
        (player.email || "—") +
        "</span></div>" +
        '  <div class="ci-side-row"><span class="ci-side-label">Balance</span><span class="ci-side-value">' +
        balanceLabel +
        "</span></div>" +
        "</div>";

      const drilldownsHtml =
        '<div class="ci-side-section">' +
        "  <h4>Player Drilldowns</h4>" +
        '  <div class="ci-side-controls-row">' +
        '    <button type="button" class="ci-btn-ghost" id="ci-player-view-log">View in Log</button>' +
        '    <button type="button" class="ci-btn-ghost" id="ci-player-view-ledger">View in Game Ledger</button>' +
        "  </div>" +
        '  <div class="ci-side-controls-row" style="margin-top:4px;">' +
        '    <button type="button" class="ci-btn-ghost" id="ci-player-view-rewards">View Rewards &amp; Cashouts</button>' +
        "  </div>" +
        "</div>";

      const kycStatus = player.kycStatus || "";
      const riskStatus = player.riskStatus || "";
      const vipLevel = player.vipLevel || "";
      const flagNotes = player.flagNotes || "";
      const selfUntil = player.selfExcludedUntil || "";
      const selfReason = player.selfExclusionReason || "";
      const selfActive =
        player.selfExclusionActive === true ||
        String(player.selfExclusionActive || "")
          .toLowerCase()
          .match(/^(true|yes|y|1|active|on)$/);

      const kycHtml =
        '<div class="ci-side-section">' +
        '  <h4>KYC, Risk &amp; VIP</h4>' +
        '  <div class="ci-field" style="margin-bottom:6px;">' +
        '    <label style="font-size:11px;">KYC Status</label>' +
        '    <select class="ci-select" id="ci-player-kyc-status">' +
        '      <option value="">(no value)</option>' +
        '      <option value="Pending"' +
        (kycStatus === "Pending" ? " selected" : "") +
        ">Pending</option>" +
        '      <option value="Approved"' +
        (kycStatus === "Approved" ? " selected" : "") +
        ">Approved</option>" +
        '      <option value="Declined"' +
        (kycStatus === "Declined" ? " selected" : "") +
        ">Declined</option>" +
        '      <option value="Review"' +
        (kycStatus === "Review" ? " selected" : "") +
        ">Review</option>" +
        "    </select>" +
        "  </div>" +
        '  <div class="ci-side-grid">' +
        '    <div class="ci-field" style="margin-bottom:6px;">' +
        '      <label style="font-size:11px;">Risk Status</label>' +
        '      <select class="ci-select" id="ci-player-risk-status">' +
        '        <option value="">(no value)</option>' +
        '        <option value="Low"' +
        (riskStatus === "Low" ? " selected" : "") +
        ">Low</option>" +
        '        <option value="Medium"' +
        (riskStatus === "Medium" ? " selected" : "") +
        ">Medium</option>" +
        '        <option value="High"' +
        (riskStatus === "High" ? " selected" : "") +
        ">High</option>" +
        "      </select>" +
        "    </div>" +
        '    <div class="ci-field" style="margin-bottom:6px;">' +
        '      <label style="font-size:11px;">VIP Level</label>' +
        '      <select class="ci-select" id="ci-player-vip-level">' +
        '        <option value="">(none)</option>' +
        '        <option value="Bronze"' +
        (vipLevel === "Bronze" ? " selected" : "") +
        ">Bronze</option>" +
        '        <option value="Silver"' +
        (vipLevel === "Silver" ? " selected" : "") +
        ">Silver</option>" +
        '        <option value="Gold"' +
        (vipLevel === "Gold" ? " selected" : "") +
        ">Gold</option>" +
        '        <option value="Platinum"' +
        (vipLevel === "Platinum" ? " selected" : "") +
        ">Platinum</option>" +
        '        <option value="Diamond"' +
        (vipLevel === "Diamond" ? " selected" : "") +
        ">Diamond</option>" +
        "      </select>" +
        "    </div>" +
        "  </div>" +
        '  <div class="ci-field" style="margin-bottom:6px;">' +
        '    <label style="font-size:11px;">Flag Notes</label>' +
        '    <textarea class="ci-textarea" id="ci-player-flag-notes" rows="2">' +
        (flagNotes || "") +
        "</textarea>" +
        "  </div>" +
        '  <div class="ci-side-controls-row">' +
        '    <button type="button" class="ci-btn-secondary" id="ci-player-save-flags-btn">Save Flags</button>' +
        "  </div>" +
        "</div>";

      const selfExclHtml =
        '<div class="ci-side-section">' +
        "  <h4>Self-Exclusion</h4>" +
        '  <div class="ci-side-grid">' +
        '    <div class="ci-field" style="margin-bottom:6px;">' +
        '      <label style="font-size:11px;">Excluded Until</label>' +
        '      <input type="text" class="ci-input" id="ci-player-self-until" placeholder="YYYY-MM-DD" value="' +
        (selfUntil || "") +
        '"/>' +
        "    </div>" +
        '    <div class="ci-field" style="margin-bottom:6px;">' +
        '      <label style="font-size:11px;">Active</label>' +
        '      <select class="ci-select" id="ci-player-self-active">' +
        '        <option value="false"' +
        (!selfActive ? " selected" : "") +
        ">No</option>" +
        '        <option value="true"' +
        (selfActive ? " selected" : "") +
        ">Yes</option>" +
        "      </select>" +
        "    </div>" +
        "  </div>" +
        '  <div class="ci-field" style="margin-bottom:6px;">' +
        '    <label style="font-size:11px;">Reason</label>' +
        '    <textarea class="ci-textarea" id="ci-player-self-reason" rows="2">' +
        (selfReason || "") +
        "</textarea>" +
        "  </div>" +
        '  <div class="ci-side-callout">' +
        "    Self-exclusion is a player-protection control. Changing these values should follow your house policy and any regulatory guidelines." +
        "  </div>" +
        "</div>";

      const adjustHtml =
        '<div class="ci-side-section">' +
        "  <h4>Adjust / Comp Chips</h4>" +
        '  <div class="ci-field" style="margin-bottom:6px;">' +
        '    <label style="font-size:11px;">Adjustment Amount (+/− chips)</label>' +
        '    <input type="number" class="ci-input" id="ci-player-adjust-amount" placeholder="e.g. 25000 or -5000"/>' +
        "  </div>" +
        '  <div class="ci-field" style="margin-bottom:6px;">' +
        '    <label style="font-size:11px;">Notes / Reason</label>' +
        '    <textarea class="ci-textarea" id="ci-player-adjust-notes" rows="2" placeholder="Internal notes for this adjustment…"></textarea>' +
        "  </div>" +
        '  <div class="ci-side-controls-row">' +
        '    <button type="button" class="ci-btn-secondary" id="ci-player-apply-adjustment">Apply Adjustment</button>' +
        '    <button type="button" class="ci-btn-ghost" id="ci-player-manual-cashout">Manual Cashout</button>' +
        "  </div>" +
        '  <div class="ci-side-callout">' +
        "    Positive amounts add chips (comps / corrections). Negative amounts deduct chips. All activity is logged and can be reconciled in the Game Ledger and Log sheets." +
        "  </div>" +
        "</div>";

      return headerHtml + drilldownsHtml + kycHtml + selfExclHtml + adjustHtml;
    }

    function renderPlayerDetail(player) {
      const container = qs("#ci-players-detail-body");
      const pill = qs("#ci-players-detail-pill");
      if (!container) return;

      container.innerHTML = buildPlayerDetailHtml(player);
      if (pill) {
        const label =
          (player.username || player.fullName || player.playerId || "Player").toString();
        pill.textContent = trimString(label, 26);
      }

      const saveFlagsBtn = qs("#ci-player-save-flags-btn");
      if (saveFlagsBtn) {
        saveFlagsBtn.addEventListener("click", function () {
          savePlayerFlagsFromDetail(player);
        });
      }

      const applyAdjBtn = qs("#ci-player-apply-adjustment");
      if (applyAdjBtn) {
        applyAdjBtn.addEventListener("click", function () {
          applyPlayerAdjustmentFromDetail(player, false);
        });
      }

      const manualCashoutBtn = qs("#ci-player-manual-cashout");
      if (manualCashoutBtn) {
        manualCashoutBtn.addEventListener("click", function () {
          applyPlayerAdjustmentFromDetail(player, true);
        });
      }

      const viewLogBtn = qs("#ci-player-view-log");
      if (viewLogBtn) {
        viewLogBtn.addEventListener("click", function () {
          drilldownToGridForPlayer("log", player);
        });
      }

      const viewLedgerBtn = qs("#ci-player-view-ledger");
      if (viewLedgerBtn) {
        viewLedgerBtn.addEventListener("click", function () {
          drilldownToGridForPlayer("gameLedger", player);
        });
      }

      const viewRewardsBtn = qs("#ci-player-view-rewards");
      if (viewRewardsBtn) {
        viewRewardsBtn.addEventListener("click", function () {
          drilldownPlayerRewardsAndCashouts(player);
        });
      }
    }

    function getPlayerSearchKey(player) {
      if (!player) return "";
      const pid = (player.playerId || "").toString().trim();
      if (pid) return pid;
      const username = (player.username || "").toString().trim();
      if (username) return username;
      const email = (player.email || "").toString().trim();
      if (email) return email;
      return "";
    }

    function drilldownToGridForPlayer(gridName, player) {
      const searchValue = getPlayerSearchKey(player);
      if (!searchValue) {
        setStatus(
          "No Player ID / Username / Email available for drilldown.",
          true
        );
        return;
      }

      const searchInput = qs('[data-grid-search="' + gridName + '"]');
      if (searchInput) {
        searchInput.value = searchValue;
      }

      activateTab(gridName);

      const grid = ciState.grids[gridName];
      if (grid) {
        grid.page = 1;
        applyGridFilterAndRender(gridName);
      }
    }

    function drilldownPlayerRewardsAndCashouts(player) {
      const searchValue = getPlayerSearchKey(player);
      if (!searchValue) {
        setStatus(
          "No Player ID / Username / Email available for drilldown.",
          true
        );
        return;
      }

      const rewardsInput = qs('[data-grid-search="rewards"]');
      if (rewardsInput) {
        rewardsInput.value = searchValue;
      }

      const cashoutsInput = qs('[data-grid-search="cashouts"]');
      if (cashoutsInput) {
        cashoutsInput.value = searchValue;
      }

      const rewardsGrid = ciState.grids.rewards;
      if (rewardsGrid) {
        rewardsGrid.page = 1;
        applyGridFilterAndRender("rewards");
      }

      const cashoutsGrid = ciState.grids.cashouts;
      if (cashoutsGrid) {
        cashoutsGrid.page = 1;
        applyGridFilterAndRender("cashouts");
      }

      activateTab("rewards");
    }

    async function savePlayerFlagsFromDetail(player) {
      if (!ciState.apiKey) return;

      const kycEl = qs("#ci-player-kyc-status");
      const riskEl = qs("#ci-player-risk-status");
      const vipEl = qs("#ci-player-vip-level");
      const flagNotesEl = qs("#ci-player-flag-notes");
      const selfUntilEl = qs("#ci-player-self-until");
      const selfActiveEl = qs("#ci-player-self-active");
      const selfReasonEl = qs("#ci-player-self-reason");

      const params = {
        playerId: player.playerId || "",
        username: player.username || "",
        email: player.email || "",
        kycStatus: kycEl ? kycEl.value : "",
        riskStatus: riskEl ? riskEl.value : "",
        vipLevel: vipEl ? vipEl.value : "",
        flagNotes: flagNotesEl ? flagNotesEl.value : "",
        selfExcludedUntil: selfUntilEl ? selfUntilEl.value : "",
        selfExclusionReason: selfReasonEl ? selfReasonEl.value : "",
        selfExclusionActive: selfActiveEl ? selfActiveEl.value : "false",
      };

      setLoading(true, "Saving player flags…");
      setStatus("Saving updated KYC / risk / VIP flags to Players…", false);

      try {
        const res = await adminGet("savePlayerFlags", params);
        if (!res || !res.ok) {
          throw new Error((res && res.error) || "Unknown error");
        }
        setStatus("Player flags saved successfully.", false);
      } catch (err) {
        setStatus(
          "Failed to save player flags: " + String(err.message || err),
          true
        );
      } finally {
        setLoading(false);
      }
    }

    async function applyPlayerAdjustmentFromDetail(player, isManualCashout) {
      if (!ciState.apiKey) return;

      const amountEl = qs("#ci-player-adjust-amount");
      const notesEl = qs("#ci-player-adjust-notes");
      if (!amountEl) return;

      const raw = amountEl.value;
      const amount = Number(raw);
      if (!raw || isNaN(amount) || !amount) {
        setStatus(
          "Enter a non-zero Adjustment Amount (+/− chips) before applying.",
          true
        );
        return;
      }

      const notes = notesEl ? notesEl.value : "";

      if (isManualCashout && amount > 0) {
        setStatus(
          "For manual cashouts, use a negative amount to deduct chips.",
          true
        );
        return;
      }

      const payload = {
        eventType: isManualCashout ? "cashout_request" : "credit",
        playerId: player.playerId || "",
        username: player.username || "",
        fullName: player.fullName || "",
        email: player.email || "",
        notes: notes || "",
      };

      if (isManualCashout) {
        payload.requestChips = Math.abs(amount);
        payload.payoutMethod = "Manual cashout via Admin Portal";
        payload.payoutAddress = player.email || "";
      } else {
        payload.creditChips = amount;
        payload.delta = amount;
        payload.deltaType = amount > 0 ? "bonus" : "adjustment";
        payload.source = "Admin Portal — Adjustment Amount";
        payload.creditSource = "Admin Portal — Adjustment Amount";
      }

      setLoading(true, isManualCashout ? "Submitting cashout…" : "Applying adjustment…");
      setStatus(
        (isManualCashout
          ? "Submitting manual cashout request…"
          : "Applying chip adjustment via Events pipeline…"),
        false
      );

      try {
        const res = await postJson(CI_BACKEND_URL, payload);
        if (!res || res.ok === false) {
          const msg =
            (res && (res.error || res.message)) ||
            "Unknown backend error";
          throw new Error(msg);
        }

        setStatus(
          isManualCashout
            ? "Cashout event submitted. Check Cashouts and Log sheets for details."
            : "Adjustment submitted. Balances will reflect in Players / Game Ledger / Log.",
          false
        );

        await loadPlayers();
      } catch (err) {
        setStatus(
          "Failed to apply adjustment: " + String(err.message || err),
          true
        );
      } finally {
        setLoading(false);
      }
    }

    // REPORTS: rebuild + refresh
    async function loadReports() {
      await loadSheetGrid("reports", "Reports", 500);
    }

    async function rebuildAndLoadReports() {
      setLoading(true, "Updating Reports…");
      setStatus("Updating Reports and reloading…", false);

      try {
        const res = await adminGet("refreshReports", {});
        if (!res || !res.ok) {
          throw new Error((res && res.error) || "Unknown error");
        }
        await loadReports();
        setStatus("Reports updated.", false);
      } catch (err) {
        setStatus(
          "Failed to rebuild Reports: " + String(err.message || err),
          true
        );
      } finally {
        setLoading(false);
      }
    }

    // INIT
    function initAdminPortal() {
      const label = qs("#ci-admin-webapp-label");
      if (label) {
        label.textContent = "Configured";
      }

      const loginForm = qs("#ci-admin-login-form");
      const loginReset = qs("#ci-admin-login-reset");
      if (loginForm) {
        loginForm.addEventListener("submit", handleAdminLogin);
      }
      if (loginReset) {
        loginReset.addEventListener("click", resetLoginForm);
      }

      qsa(".ci-admin-tab").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const name = btn.getAttribute("data-tab");
          if (!name) return;
          activateTab(name);
        });
      });

      initSheetGrids();
      attachGridDomHandlers();
      initPlayersDomHandlers();

      const dashboardRefreshBtn = qs("#ci-dashboard-refresh-btn");
      if (dashboardRefreshBtn) {
        dashboardRefreshBtn.addEventListener("click", function () {
          loadDashboard();
        });
      }

      const reportsRefreshBtn = qs("#ci-reports-refresh-btn");
      if (reportsRefreshBtn) {
        reportsRefreshBtn.addEventListener("click", function () {
          rebuildAndLoadReports();
        });
      }

      setStatus("Enter your admin credentials to unlock the portal.", false);
      setOnlineBadge(false);
    }

    document.addEventListener("DOMContentLoaded", initAdminPortal);
  </script>
</body>
</html>
