<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cook International Casino — Admin Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #05020b;
      --card-bg: radial-gradient(circle at top, #372257 0, #07030f 55%, #020007 100%);
      --border: rgba(247, 216, 122, 0.35);
      --accent: #f7d87a;
      --accent-soft: rgba(247, 216, 122, 0.12);
      --text-main: #f9f6ff;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
      --surface: rgba(15, 23, 42, 0.92);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #02000a;
      color: var(--text-main);
    }

    .ci-admin-root {
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px;
      background:
        radial-gradient(circle at top, #372257 0, #05020b 55%, #020007 100%);
    }

    .ci-admin-shell {
      width: 100%;
      max-width: 1280px;
      min-height: calc(100vh - 64px);
      background: var(--card-bg);
      border-radius: 26px;
      border: 1px solid var(--border);
      box-shadow:
        0 24px 80px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      overflow: visible;
    }

    .ci-admin-header {
      padding: 18px 24px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .ci-admin-brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .ci-admin-logo {
      width: 185px;
      max-width: 48vw;
      height: auto;
      display: block;
    }

    .ci-admin-titleblock {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ci-admin-kicker {
      font-size: 11px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .ci-admin-title {
      font-size: 18px;
      font-weight: 600;
      color: #fef9c3;
    }

    .ci-admin-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .ci-admin-header-meta {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .ci-admin-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 8px 16px 16px;
      overflow: visible;
    }

    #ci-admin-login-view,
    #ci-admin-app-view {
      width: 100%;
    }

    #ci-admin-login-view {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 0 40px;
    }

    .ci-card {
      background: linear-gradient(
        145deg,
        rgba(17, 24, 39, 0.96),
        rgba(15, 23, 42, 0.96)
      );
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow:
        0 18px 50px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      padding: 24px 22px 22px;
      max-width: 420px;
      width: 100%;
      color: var(--text-main);
    }

    .ci-card h2 {
      margin: 0 0 4px;
      font-size: 20px;
      font-weight: 600;
    }

    .ci-card p {
      margin: 0 0 18px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .ci-field {
      margin-bottom: 14px;
    }

    .ci-field label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .ci-input,
    .ci-select,
    .ci-textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
    }

    .ci-input:focus,
    .ci-select:focus,
    .ci-textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(247, 216, 122, 0.45);
      background: rgba(15, 23, 42, 1);
    }

    .ci-textarea {
      min-height: 72px;
      resize: vertical;
    }

    .ci-input::-webkit-outer-spin-button,
    .ci-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .ci-input[type="number"] {
      -moz-appearance: textfield;
    }

    .ci-btn-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 4px;
    }

    .ci-btn,
    .ci-btn-secondary,
    .ci-btn-ghost,
    .ci-badge {
      font-family: inherit;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: background 0.12s ease, box-shadow 0.12s ease,
        transform 0.06s ease, border-color 0.12s ease;
      white-space: nowrap;
    }

    .ci-btn {
      background: linear-gradient(135deg, #facc6b, #f7d87a);
      color: #221600;
      padding: 7px 16px;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(248, 213, 116, 0.25);
    }

    .ci-btn:hover {
      box-shadow: 0 10px 26px rgba(248, 213, 116, 0.3);
      transform: translateY(-0.5px);
    }

    .ci-btn:active {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
      transform: translateY(0.5px);
    }

    .ci-btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.9);
      padding: 6px 13px;
    }

    .ci-btn-secondary:hover {
      border-color: var(--accent);
      background: rgba(15, 23, 42, 1);
    }

    .ci-btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 5px 11px;
      font-size: 12px;
    }

    .ci-btn-ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(15, 23, 42, 0.9);
    }

    .ci-badge {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.9);
    }

    .ci-badge-online {
      color: var(--success);
      border-color: rgba(74, 222, 128, 0.8);
    }

    .ci-badge-danger {
      color: var(--danger);
      border-color: rgba(248, 113, 113, 0.85);
    }

    .ci-admin-footer {
      padding: 8px 18px 10px;
      border-top: 1px solid rgba(30, 41, 59, 0.8);
      font-size: 11px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      text-align: center;
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.96);
    }

    /* Status + loading */
    .ci-admin-status {
      min-height: 20px;
      padding: 6px 12px;
      font-size: 11px;
      color: var(--text-muted);
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
      display: flex;
      align-items: center;
      gap: 8px;
      max-width: 540px;
      margin: 0 auto 8px;
    }

    .ci-admin-status-error {
      color: var(--danger);
      border-color: rgba(248, 113, 113, 0.85);
      background: rgba(30, 64, 175, 0.1);
    }

    .ci-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      flex-shrink: 0;
    }

    .ci-admin-loading {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center, rgba(15, 23, 42, 0.28), rgba(15, 23, 42, 0.9));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .ci-admin-loading-inner {
      padding: 16px 20px;
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.75);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: #e5e7eb;
    }

    .ci-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      border-top-color: var(--accent);
      animation: ci-spin 0.8s linear infinite;
    }

    @keyframes ci-spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* App view */
    #ci-admin-app-view {
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 6px 0 20px;
    }

    .ci-admin-tabs {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      padding: 4px 2px 2px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(30, 64, 175, 0.5);
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .ci-admin-tabs::-webkit-scrollbar {
      height: 5px;
    }

    .ci-admin-tabs::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }

    .ci-admin-tab {
      border-radius: 999px;
      border: none;
      padding: 5px 12px;
      font-size: 12px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .ci-admin-tab span {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .ci-admin-tab strong {
      font-weight: 500;
    }

    .ci-admin-tab-active {
      background: radial-gradient(circle at top, rgba(247, 216, 122, 0.08), rgba(15, 23, 42, 0.98));
      color: #fef9c3;
      box-shadow:
        0 0 0 1px rgba(248, 213, 116, 0.45),
        0 10px 24px rgba(0, 0, 0, 0.9);
    }

    .ci-admin-tab-active strong {
      color: #fef9c3;
    }

    .ci-admin-panels {
      margin-top: 10px;
      flex: 1;
      min-height: 0;
    }

    .ci-admin-panel {
      display: none;
      border-radius: 22px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(30, 64, 175, 0.8);
      padding: 14px 14px 12px;
      min-height: 420px;
      flex-direction: column;
      overflow: visible;
    }

    .ci-admin-panel-active {
      display: flex;
    }

    .ci-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.85);
      margin-bottom: 8px;
    }

    .ci-panel-header-left h2 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .ci-panel-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .ci-panel-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .ci-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .ci-toolbar-left,
    .ci-toolbar-right {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .ci-toolbar-search-wrap {
      position: relative;
      flex: 1 1 220px;
      min-width: 180px;
    }

    .ci-toolbar-search {
      padding-left: 24px;
    }

    .ci-toolbar-search-icon {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.9);
      box-sizing: border-box;
    }

    .ci-toolbar-search-icon::after {
      content: "";
      position: absolute;
      right: -4px;
      bottom: -5px;
      width: 5px;
      height: 2px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
      transform: rotate(45deg);
    }

    .ci-toolbar label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .ci-toolbar select {
      min-width: 64px;
      font-size: 11px;
    }

    .ci-table-wrap {
      border-radius: 16px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.22), rgba(15, 23, 42, 0.98));
      overflow: hidden;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .ci-table-scroll {
      overflow: auto;
      flex: 1;
    }

    table.ci-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 640px;
    }

    .ci-table thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: rgba(15, 23, 42, 0.98);
    }

    .ci-table th,
    .ci-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.6);
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ci-table th {
      font-weight: 500;
      color: #e5e7eb;
      cursor: pointer;
      position: relative;
      user-select: none;
    }

    .ci-table th[data-sortable="false"] {
      cursor: default;
    }

    .ci-table th span.ci-sort-indicator {
      font-size: 9px;
      margin-left: 4px;
      opacity: 0.7;
    }

    .ci-table tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.88);
    }

    .ci-table tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.96);
    }

    .ci-table tr:hover td {
      background: rgba(30, 64, 175, 0.6);
    }

    .ci-table-row-selected td {
      background: rgba(247, 216, 122, 0.08) !important;
    }

    .ci-tag {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 1px 8px 2px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: var(--text-muted);
    }

    .ci-tag-green {
      border-color: rgba(74, 222, 128, 0.9);
      color: var(--success);
    }

    .ci-tag-red {
      border-color: rgba(248, 113, 113, 0.9);
      color: var(--danger);
    }

    .ci-tag-gold {
      border-color: rgba(247, 216, 122, 0.9);
      color: #fef9c3;
    }

    .ci-pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 8px;
      font-size: 11px;
      color: var(--text-muted);
      border-top: 1px solid rgba(30, 64, 175, 0.9);
      background: rgba(15, 23, 42, 0.98);
    }

    .ci-pagination span {
      white-space: nowrap;
    }

    .ci-link-button {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      color: #bfdbfe;
      cursor: pointer;
      font: inherit;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .ci-link-button:hover {
      color: #f9f6ff;
    }

    .ci-split {
      display: grid;
      grid-template-columns: minmax(0, 2.3fr) minmax(260px, 1.2fr);
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .ci-split-main {
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
    }

    .ci-split-side {
      border-radius: 16px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.25), rgba(15, 23, 42, 0.98));
      padding: 10px 10px 8px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .ci-side-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.8);
      padding-bottom: 4px;
      margin-bottom: 4px;
    }

    .ci-side-title h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .ci-side-section {
      border-radius: 12px;
      border: 1px solid rgba(30, 64, 175, 0.85);
      padding: 6px 7px;
      background: rgba(15, 23, 42, 0.95);
      margin-bottom: 6px;
    }

    .ci-side-section h4 {
      margin: 0 0 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .ci-side-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .ci-side-label {
      color: var(--text-muted);
    }

    .ci-side-value {
      text-align: right;
    }

    .ci-side-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 8px;
      font-size: 11px;
    }

    .ci-side-controls-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .ci-side-callout {
      font-size: 11px;
      color: var(--text-muted);
      padding: 4px 6px;
      border-radius: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      margin-top: 2px;
    }

    .ci-kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .ci-kpi-card {
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.3), rgba(15, 23, 42, 0.98));
      padding: 8px 9px 7px;
      font-size: 11px;
    }

    .ci-kpi-label {
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .ci-kpi-value {
      font-size: 16px;
      font-weight: 600;
      color: #fef9c3;
    }

    .ci-kpi-note {
      font-size: 10px;
      color: var(--text-muted);
    }

    .ci-dashboard-bottom {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 10px;
      margin-top: 6px;
      min-height: 0;
      flex: 1;
    }

    .ci-dashboard-card {
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 8px 9px 6px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .ci-dashboard-card h3 {
      margin: 0 0 4px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .ci-dashboard-card ul {
      list-style: none;
      padding: 0;
      margin: 2px 0 0;
      font-size: 11px;
    }

    .ci-dashboard-card li {
      margin-bottom: 3px;
      color: var(--text-muted);
    }

    .ci-dashboard-mini-table {
      border-radius: 10px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 4px;
      margin-top: 4px;
      overflow: auto;
      max-height: 240px;
    }

    .ci-dashboard-mini-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      min-width: 320px;
    }

    .ci-dashboard-mini-table th,
    .ci-dashboard-mini-table td {
      border-bottom: 1px solid rgba(30, 64, 175, 0.75);
      padding: 4px 5px;
      white-space: nowrap;
    }

    /* Small utility */
    .ci-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .ci-pill {
      border-radius: 999px;
      padding: 2px 6px 3px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: var(--text-muted);
    }

    /* Responsive tweaks */
    @media (max-width: 960px) {
      .ci-admin-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .ci-admin-header-meta {
        text-align: left;
      }

      .ci-split {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 600px) {
      .ci-admin-shell {
        border-radius: 0;
      }

      .ci-admin-root {
        padding: 0;
      }

      .ci-admin-main {
        padding: 8px 10px 12px;
      }

      .ci-admin-panel {
        max-height: none;
      }
    }

    /* Print: only print active panel content */
    @media print {
      body {
        background: #ffffff;
      }

      .ci-admin-root {
        padding: 0;
      }

      .ci-admin-shell {
        min-height: auto;
        box-shadow: none;
        border-radius: 0;
      }

      .ci-admin-header,
      .ci-admin-footer,
      .ci-admin-tabs,
      #ci-admin-login-view,
      .ci-admin-status,
      .ci-pagination,
      .ci-admin-loading {
        display: none !important;
      }

      .ci-admin-panel {
        display: none !important;
        border: none;
        max-height: none;
      }

      .ci-admin-panel-active {
        display: block !important;
        border: none;
        box-shadow: none;
      }
    }
  </style>
</head>

<body>
  <div class="ci-admin-root">
    <div class="ci-admin-shell">
      <header class="ci-admin-header">
        <div class="ci-admin-brand">
          <img
            src="https://www.cook-international.com/s/CookIntlCasino.png"
            alt="Cook International Casino"
            class="ci-admin-logo"
          />
          <div class="ci-admin-titleblock">
            <div class="ci-admin-kicker">Cook International Casino</div>
            <div class="ci-admin-title">Admin Portal &amp; House Dashboard</div>
            <div class="ci-admin-subtitle"></div>
          </div>
        </div>
        <div class="ci-admin-header-meta">
          <div>Status: <span class="ci-badge ci-badge-online" id="ci-admin-status-badge">Offline</span></div>
          <div class="ci-mono" style="margin-top: 2px; opacity: 0.8;">
            Web App: <span id="ci-admin-webapp-label">Script Endpoint</span>
          </div>
        </div>
      </header>

      <main class="ci-admin-main">
        <div id="ci-admin-status-strip" class="ci-admin-status">
          <span class="ci-dot"></span>
          <span id="ci-admin-status-text">Enter your admin credentials to unlock the portal.</span>
        </div>

        <!-- LOGIN VIEW -->
        <section id="ci-admin-login-view">
          <div class="ci-card">
            <h2>Admin Login</h2>
            <p>
              Sign in with your internal Cook International Casino admin credentials.
              This panel is for house use only.
            </p>

            <form id="ci-admin-login-form" autocomplete="off">
              <div class="ci-field">
                <label for="ci-admin-username">Admin Email / Username</label>
                <input
                  id="ci-admin-username"
                  class="ci-input"
                  type="email"
                  inputmode="email"
                  autocomplete="off"
                  placeholder="info@cook-international.com"
                  required
                />
              </div>

              <div class="ci-field">
                <label for="ci-admin-password">Password</label>
                <input
                  id="ci-admin-password"
                  class="ci-input"
                  type="password"
                  autocomplete="off"
                  placeholder="Enter admin password"
                  required
                />
              </div>

              <div class="ci-btn-row">
                <button type="submit" class="ci-btn">Sign In</button>
                <button type="button" class="ci-btn-secondary" id="ci-admin-login-reset">
                  Clear
                </button>
              </div>
            </form>

            <div style="margin-top: 14px; font-size: 11px; color: var(--text-muted);">
              All activity in this portal is logged to <span class="ci-mono">Admin Log</span>.
            </div>
          </div>
        </section>

        <!-- APP VIEW -->
        <section id="ci-admin-app-view">
          <!-- Tabs -->
          <nav class="ci-admin-tabs" aria-label="Admin sections">
            <button type="button" class="ci-admin-tab" data-tab="dashboard">
              <span>DASHBOARD</span><strong>Overview</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="players">
              <span>PLAYERS</span><strong>Accounts</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="log">
              <span>LOG</span><strong>Events</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="gameLedger">
              <span>LEDGER</span><strong>Game Rounds</strong>
            </button>

            <!-- Back office tabs, in requested order -->
            <button type="button" class="ci-admin-tab" data-tab="adminLog">
              <span>ADMIN</span><strong>Log</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="rewards">
              <span>REWARDS</span><strong>Ledger</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="cashouts">
              <span>CASHOUTS</span><strong>Requests</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="reports">
              <span>REPORTS</span><strong>KPIs</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="blacklist">
              <span>BLACKLIST</span><strong>Risk</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="stripe">
              <span>STRIPE</span><strong>Ledger</strong>
            </button>
            <button type="button" class="ci-admin-tab" data-tab="paypal">
              <span>PAYPAL</span><strong>Ledger</strong>
            </button>
          </nav>

          <!-- Panels -->
          <div class="ci-admin-panels">
            <!-- DASHBOARD PANEL -->
            <section class="ci-admin-panel" data-panel="dashboard">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>House Dashboard</h2>
                  <div class="ci-panel-subtitle">
                    Snapshot of overall casino health and recent activity.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" id="ci-dashboard-refresh-btn">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="dashboard">
                    Print
                  </button>
                </div>
              </div>

              <div style="display:flex;flex-direction:column;gap:8px;flex:1;min-height:0;">
                <div class="ci-kpi-row">
                  <div class="ci-kpi-card">
                    <div class="ci-kpi-label">Total Player Accounts</div>
                    <div class="ci-kpi-value" id="ci-kpi-total-players">–</div>
                    <div class="ci-kpi-note">Unique Player IDs on file.</div>
                  </div>
                  <div class="ci-kpi-card">
                    <div class="ci-kpi-label">Total Chips in Wallets</div>
                    <div class="ci-kpi-value" id="ci-kpi-total-balance">–</div>
                    <div class="ci-kpi-note">Sum of Current Balance from Players.</div>
                  </div>
                  <div class="ci-kpi-card">
                    <div class="ci-kpi-label">Open Cashout Requests (recent)</div>
                    <div class="ci-kpi-value" id="ci-kpi-open-cashouts">–</div>
                    <div class="ci-kpi-note">Latest entries from Cashouts sheet.</div>
                  </div>
                  <div class="ci-kpi-card">
                    <div class="ci-kpi-label">High-Risk Players</div>
                    <div class="ci-kpi-value" id="ci-kpi-high-risk">–</div>
                    <div class="ci-kpi-note">Risk Status set to “High”.</div>
                  </div>
                </div>

                <div class="ci-dashboard-bottom">
                  <div class="ci-dashboard-card">
                    <h3>VIP Snapshot</h3>
                    <ul id="ci-dashboard-vip-list">
                      <li>Loading VIP distribution from Players…</li>
                    </ul>

                    <div class="ci-dashboard-mini-table" id="ci-dashboard-top-players-wrap">
                      <table>
                        <thead>
                          <tr>
                            <th>Player</th>
                            <th>VIP</th>
                            <th>Balance</th>
                          </tr>
                        </thead>
                        <tbody id="ci-dashboard-top-players-body">
                          <tr>
                            <td colspan="3" style="text-align:center;color:var(--text-muted);">
                              Waiting for data…
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="ci-dashboard-card">
                    <h3>Recent Cashouts</h3>
                    <div class="ci-dashboard-mini-table">
                      <table>
                        <thead>
                          <tr>
                            <th>When</th>
                            <th>Player</th>
                            <th>Requested</th>
                            <th>Method</th>
                          </tr>
                        </thead>
                        <tbody id="ci-dashboard-recent-cashouts-body">
                          <tr>
                            <td colspan="4" style="text-align:center;color:var(--text-muted);">
                              Waiting for data…
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- PLAYERS PANEL -->
            <section class="ci-admin-panel" data-panel="players" id="ci-panel-players">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Players</h2>
                  <div class="ci-panel-subtitle">
                    Player accounts, balances, KYC, risk, VIP &amp; self-exclusion.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" id="ci-players-refresh-btn">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="players">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-split">
                <div class="ci-split-main">
                  <div class="ci-toolbar">
                    <div class="ci-toolbar-left">
                      <div class="ci-toolbar-search-wrap">
                        <span class="ci-toolbar-search-icon"></span>
                        <input
                          type="search"
                          class="ci-input ci-toolbar-search"
                          id="ci-players-search"
                          placeholder="Search (Player ID, Username, Full Name, Email...)"
                          autocomplete="off"
                        />
                      </div>
                      <button type="button" class="ci-btn-ghost" id="ci-players-show-all">
                        Show All
                      </button>
                    </div>
                    <div class="ci-toolbar-right">
                      <label>
                        Page Size
                        <select class="ci-select" id="ci-players-page-size">
                          <option value="10">10</option>
                          <option value="25" selected>25</option>
                          <option value="50">50</option>
                          <option value="100">100</option>
                        </select>
                      </label>
                    </div>
                  </div>

                  <div class="ci-table-wrap">
                    <div class="ci-table-scroll">
                      <table class="ci-table" id="ci-players-table">
                        <thead>
                          <tr id="ci-players-thead-row">
                            <!-- Filled by JS -->
                          </tr>
                        </thead>
                        <tbody id="ci-players-tbody">
                          <!-- Filled by JS -->
                        </tbody>
                      </table>
                    </div>
                    <div class="ci-pagination" id="ci-players-pagination">
                      <div>
                        <button type="button" class="ci-btn-ghost" id="ci-players-prev-page">
                          ◀ Prev
                        </button>
                        <button type="button" class="ci-btn-ghost" id="ci-players-next-page">
                          Next ▶
                        </button>
                      </div>
                      <div id="ci-players-page-info">Page 1 of 1 • 0 players</div>
                    </div>
                  </div>
                </div>

                <aside class="ci-split-side" id="ci-players-detail">
                  <div class="ci-side-title">
                    <h3>Player Details &amp; Adjustments</h3>
                    <span class="ci-pill" id="ci-players-detail-pill">No player selected</span>
                  </div>

                  <div id="ci-players-detail-body">
                    <div class="ci-side-callout">
                      Select a player row from the table to view account details, change
                      KYC / risk / VIP, or comp / adjust chips and trigger manual cashouts.
                    </div>
                  </div>
                </aside>
              </div>
            </section>
            <!-- LOG PANEL -->
            <section class="ci-admin-panel" data-panel="log">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Log</h2>
                  <div class="ci-panel-subtitle">
                    Player signup, login, credit, cashout and blocked_* events from the Log sheet.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="log">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="log">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Full Name, Email, Event Type...)"
                      autocomplete="off"
                      data-grid-search="log"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="log">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="log">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="log"></tr>
                    </thead>
                    <tbody data-grid-body="log"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="log">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="log">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="log">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="log">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- GAME LEDGER PANEL -->
            <section class="ci-admin-panel" data-panel="gameLedger">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Game Ledger</h2>
                  <div class="ci-panel-subtitle">
                    Per-round game results, deltas, and balance snapshots.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="gameLedger">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="gameLedger">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Game Name, Event ID...)"
                      autocomplete="off"
                      data-grid-search="gameLedger"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="gameLedger">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="gameLedger">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="gameLedger"></tr>
                    </thead>
                    <tbody data-grid-body="gameLedger"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="gameLedger">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="gameLedger">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="gameLedger">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="gameLedger">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- REWARDS PANEL -->
            <section class="ci-admin-panel" data-panel="rewards">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Rewards</h2>
                  <div class="ci-panel-subtitle">
                    Reward claims, bonuses, and comps recorded in the Rewards sheet.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="rewards">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="rewards">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Reward Type, Notes...)"
                      autocomplete="off"
                      data-grid-search="rewards"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="rewards">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="rewards">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="rewards"></tr>
                    </thead>
                    <tbody data-grid-body="rewards"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="rewards">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="rewards">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="rewards">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="rewards">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- CASHOUTS PANEL -->
            <section class="ci-admin-panel" data-panel="cashouts">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Cashouts</h2>
                  <div class="ci-panel-subtitle">
                    Dedicated cashout log — requested chips, method, details.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="cashouts">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="cashouts">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Email, Method...)"
                      autocomplete="off"
                      data-grid-search="cashouts"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="cashouts">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="cashouts">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="cashouts"></tr>
                    </thead>
                    <tbody data-grid-body="cashouts"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="cashouts">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="cashouts">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="cashouts">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="cashouts">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- STRIPE LEDGER PANEL -->
            <section class="ci-admin-panel" data-panel="stripe">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Stripe Ledger</h2>
                  <div class="ci-panel-subtitle">
                    Stripe webhook log and chip credits.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="stripe">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="stripe">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Stripe Event ID, Player ID, Email...)"
                      autocomplete="off"
                      data-grid-search="stripe"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="stripe">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="stripe">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="stripe"></tr>
                    </thead>
                    <tbody data-grid-body="stripe"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="stripe">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="stripe">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="stripe">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="stripe">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- PAYPAL LEDGER PANEL -->
            <section class="ci-admin-panel" data-panel="paypal">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>PayPal Ledger</h2>
                  <div class="ci-panel-subtitle">
                    Cashier PayPal successes and chip credits.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="paypal">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="paypal">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (PayPal Txn, Player ID, Email...)"
                      autocomplete="off"
                      data-grid-search="paypal"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="paypal">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="paypal">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="paypal"></tr>
                    </thead>
                    <tbody data-grid-body="paypal"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="paypal">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="paypal">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="paypal">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="paypal">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

            <!-- BLACKLIST PANEL -->
            <section class="ci-admin-panel" data-panel="blacklist">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Blacklist</h2>
                  <div class="ci-panel-subtitle">
                    Blocked / barred players and reasons.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="blacklist">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="blacklist">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Player ID, Username, Full Name, Email, Status...)"
                      autocomplete="off"
                      data-grid-search="blacklist"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="blacklist">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="blacklist">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="blacklist"></tr>
                    </thead>
                    <tbody data-grid-body="blacklist"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="blacklist">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="blacklist">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="blacklist">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="blacklist">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>

<!-- REPORTS PANEL -->
<section class="ci-admin-panel" data-panel="reports">
  <div class="ci-panel-header">
    <div class="ci-panel-header-left">
      <h2>Reports</h2>
      <div class="ci-panel-subtitle">
        KPIs and snapshots from the Reports sheet.
      </div>
    </div>
    <div class="ci-panel-header-right">
      <button type="button" class="ci-btn-secondary" id="ci-reports-refresh-btn">
        Rebuild &amp; Refresh
      </button>
      <button type="button" class="ci-btn-ghost" data-grid-print="reports">
        Print
      </button>
    </div>
  </div>

  <!-- NEW: KPI row for Reports -->
  <div class="ci-kpi-row" id="ci-reports-kpi-row">
    <div class="ci-kpi-card">
      <div class="ci-kpi-label">Total Chips in Wallets</div>
      <div class="ci-kpi-value" id="ci-reports-kpi-total-balance">–</div>
      <div class="ci-kpi-note">Liability snapshot from Reports.</div>
    </div>
    <div class="ci-kpi-card">
      <div class="ci-kpi-label">Total Purchased Chips (Lifetime)</div>
      <div class="ci-kpi-value" id="ci-reports-kpi-total-purchased">–</div>
      <div class="ci-kpi-note">All chips purchased across cashier.</div>
    </div>
    <div class="ci-kpi-card">
      <div class="ci-kpi-label">Total Cashed Out (Lifetime)</div>
      <div class="ci-kpi-value" id="ci-reports-kpi-total-cashed">–</div>
      <div class="ci-kpi-note">Total chips paid out to players.</div>
    </div>
    <div class="ci-kpi-card">
      <div class="ci-kpi-label">House GGR (Lifetime)</div>
      <div class="ci-kpi-value" id="ci-reports-kpi-house-ggr">–</div>
      <div class="ci-kpi-note">House net win from Reports.</div>
    </div>
  </div>

  <div class="ci-toolbar">
    <div class="ci-toolbar-left">
      <div class="ci-toolbar-search-wrap">
        <span class="ci-toolbar-search-icon"></span>
        <input
          type="search"
          class="ci-input ci-toolbar-search"
          placeholder="Search within Reports sheet…"
          autocomplete="off"
          data-grid-search="reports"
        />
      </div>
      <button type="button" class="ci-btn-ghost" data-grid-show-all="reports">
        Show All
      </button>
    </div>
    <div class="ci-toolbar-right">
      <label>
        Page Size
        <select class="ci-select" data-grid-page-size="reports">
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </label>
    </div>
  </div>

  <div class="ci-table-wrap">
    <div class="ci-table-scroll">
      <table class="ci-table">
        <thead>
          <tr data-grid-head="reports"></tr>
        </thead>
        <tbody data-grid-body="reports"></tbody>
      </table>
    </div>
    <div class="ci-pagination" data-grid-pagination="reports">
      <div>
        <button type="button" class="ci-btn-ghost" data-grid-prev="reports">
          ◀ Prev
        </button>
        <button type="button" class="ci-btn-ghost" data-grid-next="reports">
          Next ▶
        </button>
      </div>
      <div data-grid-page-info="reports">Page 1 of 1 • 0 rows</div>
    </div>
  </div>
</section>

            <!-- ADMIN LOG PANEL -->
            <section class="ci-admin-panel" data-panel="adminLog">
              <div class="ci-panel-header">
                <div class="ci-panel-header-left">
                  <h2>Admin Log</h2>
                  <div class="ci-panel-subtitle">
                    System and admin actions recorded to the Admin Log sheet.
                  </div>
                </div>
                <div class="ci-panel-header-right">
                  <button type="button" class="ci-btn-secondary" data-grid-refresh="adminLog">
                    Refresh
                  </button>
                  <button type="button" class="ci-btn-ghost" data-grid-print="adminLog">
                    Print
                  </button>
                </div>
              </div>

              <div class="ci-toolbar">
                <div class="ci-toolbar-left">
                  <div class="ci-toolbar-search-wrap">
                    <span class="ci-toolbar-search-icon"></span>
                    <input
                      type="search"
                      class="ci-input ci-toolbar-search"
                      placeholder="Search (Action, Username, Details...)"
                      autocomplete="off"
                      data-grid-search="adminLog"
                    />
                  </div>
                  <button type="button" class="ci-btn-ghost" data-grid-show-all="adminLog">
                    Show All
                  </button>
                </div>
                <div class="ci-toolbar-right">
                  <label>
                    Page Size
                    <select class="ci-select" data-grid-page-size="adminLog">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="ci-table-wrap">
                <div class="ci-table-scroll">
                  <table class="ci-table">
                    <thead>
                      <tr data-grid-head="adminLog"></tr>
                    </thead>
                    <tbody data-grid-body="adminLog"></tbody>
                  </table>
                </div>
                <div class="ci-pagination" data-grid-pagination="adminLog">
                  <div>
                    <button type="button" class="ci-btn-ghost" data-grid-prev="adminLog">
                      ◀ Prev
                    </button>
                    <button type="button" class="ci-btn-ghost" data-grid-next="adminLog">
                      Next ▶
                    </button>
                  </div>
                  <div data-grid-page-info="adminLog">Page 1 of 1 • 0 rows</div>
                </div>
              </div>
            </section>
          </div>
        </section>
      </main>

      <footer class="ci-admin-footer">
        FOR INTERNAL USE ONLY
      </footer>
    </div>
  </div>

  <div class="ci-admin-loading" id="ci-admin-loading-overlay">
    <div class="ci-admin-loading-inner">
      <div class="ci-spinner"></div>
      <div id="ci-admin-loading-text">Working…</div>
    </div>
  </div>
  <script>
"use strict";

    // Web App URL (Current Deployment)
    const CI_BACKEND_URL =
      "https://script.google.com/macros/s/AKfycbzTJ3121csJjqE3pcxYPCKT7tFgzZ68ZLn-ECBFzhrvzfx3EXZw09l3a5ePfSMwMdd2lg/exec";

    // Global state
    const ciState = {
      apiKey: null,
      adminUser: null,
      players: {
        list: [],
        filtered: [],
        page: 1,
        pageSize: 25,
        sortKey: "username",
        sortDir: "asc",
      },
      grids: {}, // sheet grids
      hasLoaded: {
        dashboard: false,
        players: false,
        log: false,
        gameLedger: false,
        adminLog: false,
        rewards: false,
        cashouts: false,
        reports: false,
        blacklist: false,
        stripe: false,
        paypal: false,
      },
      // Search debounce timer
      searchTimer: null
    };

    function qs(sel, root) {
      return (root || document).querySelector(sel);
    }
    function qsa(sel, root) {
      return Array.from((root || document).querySelectorAll(sel));
    }

    function setStatus(message, isError) {
      const strip = qs("#ci-admin-status-strip");
      const text = qs("#ci-admin-status-text");
      if (!strip || !text) return;
      text.textContent = message || "";
      strip.classList.toggle("ci-admin-status-error", !!isError);
    }

    function setLoading(isLoading, label) {
      const overlay = qs("#ci-admin-loading-overlay");
      const text = qs("#ci-admin-loading-text");
      if (!overlay) return;
      if (text && label) text.textContent = label;
      overlay.style.display = isLoading ? "flex" : "none";
    }

    function setOnlineBadge(isOnline) {
      const badge = qs("#ci-admin-status-badge");
      if (!badge) return;
      if (isOnline) {
        badge.textContent = "Online";
        badge.classList.add("ci-badge-online");
      } else {
        badge.textContent = "Offline";
        badge.classList.remove("ci-badge-online");
      }
    }

    function formatNumber(num) {
      const n = Number(num);
      if (isNaN(n)) return "0";
      return n.toLocaleString("en-US");
    }

    function formatChips(num) {
      const n = Number(num);
      if (isNaN(n)) return "0";
      return n.toLocaleString("en-US") + " chips";
    }

    function trimString(value, maxLength) {
      const s = String(value == null ? "" : value);
      if (!maxLength || s.length <= maxLength) return s;
      return s.slice(0, maxLength - 1) + "…";
    }

    // Fetch helpers
    async function postJson(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        body: JSON.stringify(payload || {}),
      });

      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error("Backend Error:", text);
        throw new Error("Invalid JSON from backend");
      }
    }

    async function getJson(url) {
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json",
        },
      });
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error("Invalid JSON from backend");
      }
    }

    // Admin GET API wrapper
    async function adminGet(action, extraParams) {
      if (!ciState.apiKey) {
        throw new Error("Admin API key missing");
      }
      const params = Object.assign({}, extraParams || {}, {
        mode: "admin_api",
        action: action,
        apiKey: ciState.apiKey,
      });

      const usp = new URLSearchParams();
      Object.keys(params).forEach(function (key) {
        if (params[key] == null) return;
        usp.append(key, String(params[key]));
      });

      const url = CI_BACKEND_URL + "?" + usp.toString();
      return getJson(url);
    }

    // Helper: load Players from the Players sheet via getSheet
    async function fetchPlayersFromSheet(maxRows) {
      if (!ciState.apiKey) {
        throw new Error("Admin API key missing");
      }

      const res = await adminGet("getSheet", {
        sheetName: "Players",
        maxRows: maxRows || 2000,
      });

      if (!res || !res.ok) {
        throw new Error((res && res.error) || "Failed to load Players sheet");
      }

      const headers = res.headers || [];
      const rows = res.rows || [];

      // Dynamic Header Mapping
      const idxPlayerId = headers.indexOf("Player ID");
      const idxUsername = headers.indexOf("Username");
      const idxFullName = headers.indexOf("Full Name");
      const idxEmail = headers.indexOf("Email");
      const idxBalance = headers.indexOf("Current Balance");
      const idxKycStatus = headers.indexOf("KYC Status");
      const idxRiskStatus = headers.indexOf("Risk Status");
      const idxVipLevel = headers.indexOf("VIP Level");
      const idxFlagNotes = headers.indexOf("Flag Notes");

      let idxSelfUntil = headers.indexOf("Self Excluded Until");
      if (idxSelfUntil < 0) idxSelfUntil = headers.indexOf("Self-Excluded Until");

      const idxSelfReason = headers.indexOf("Self Exclusion Reason");
      const idxSelfActive = headers.indexOf("Self Exclusion Active");

      const players = rows.map(function (row) {
          const player = {
            playerId: idxPlayerId >= 0 ? row[idxPlayerId] : "",
            username: idxUsername >= 0 ? row[idxUsername] : "",
            fullName: idxFullName >= 0 ? row[idxFullName] : "",
            email: idxEmail >= 0 ? row[idxEmail] : "",
            balance: idxBalance >= 0 ? (Number(row[idxBalance]) || 0) : 0,
            kycStatus: idxKycStatus >= 0 ? row[idxKycStatus] : "",
            riskStatus: idxRiskStatus >= 0 ? row[idxRiskStatus] : "",
            vipLevel: idxVipLevel >= 0 ? row[idxVipLevel] : "",
            flagNotes: idxFlagNotes >= 0 ? row[idxFlagNotes] : "",
            selfExcludedUntil: idxSelfUntil >= 0 ? row[idxSelfUntil] : "",
            selfExclusionReason: idxSelfReason >= 0 ? row[idxSelfReason] : "",
            selfExclusionActive: idxSelfActive >= 0 ? row[idxSelfActive] : "",
          };

          if (!player.playerId && !player.username && !player.email) {
            return null;
          }
          return player;
        })
        .filter(function (p) {
          return !!p;
        });

      return players;
    }

    // Login
    async function handleAdminLogin(event) {
      event.preventDefault();
      const usernameEl = qs("#ci-admin-username");
      const passwordEl = qs("#ci-admin-password");
      if (!usernameEl || !passwordEl) return;

      const username = usernameEl.value.trim();
      const password = passwordEl.value;
      if (!username || !password) {
        setStatus("Enter both username and password.", true);
        return;
      }

      setLoading(true, "Signing in…");
      setStatus("Signing in to Admin Portal…", false);

      try {
        const payload = {
          mode: "admin_login",
          username: username,
          password: password,
        };
        const data = await postJson(CI_BACKEND_URL, payload);

        if (!data || !data.ok || !data.apiKey) {
          setStatus("Invalid credentials or admin login failed.", true);
          setOnlineBadge(false);
          setLoading(false);
          return;
        }

        ciState.apiKey = data.apiKey;
        ciState.adminUser = username;

        setOnlineBadge(true);
        setStatus("Admin Portal unlocked. Use the tabs to navigate.", false);

        const loginView = qs("#ci-admin-login-view");
        const appView = qs("#ci-admin-app-view");
        if (loginView) loginView.style.display = "none";
        if (appView) appView.style.display = "flex";

        const webAppLabel = qs("#ci-admin-webapp-label");
        if (webAppLabel) {
          webAppLabel.textContent = "Connected";
        }

        // Auto-switch to Dashboard
        activateTab("dashboard");
        await loadDashboard();
      } catch (err) {
        setStatus("Login error: " + String(err.message || err), true);
        setOnlineBadge(false);
      } finally {
        setLoading(false);
      }
    }

    function resetLoginForm() {
      const usernameEl = qs("#ci-admin-username");
      const passwordEl = qs("#ci-admin-password");
      if (usernameEl) usernameEl.value = "";
      if (passwordEl) passwordEl.value = "";
      setStatus("Enter your admin credentials to unlock the portal.", false);
    }

    // Tab handling
    function activateTab(panelName) {
      const tabs = qsa(".ci-admin-tab");
      tabs.forEach(function (btn) {
        const name = btn.getAttribute("data-tab");
        const active = name === panelName;
        btn.classList.toggle("ci-admin-tab-active", active);
      });

      const panels = qsa(".ci-admin-panel");
      panels.forEach(function (panel) {
        const name = panel.getAttribute("data-panel");
        const active = name === panelName;
        panel.classList.toggle("ci-admin-panel-active", active);
      });

      if (!ciState.hasLoaded[panelName]) {
        ciState.hasLoaded[panelName] = true;
        if (panelName === "players") {
          loadPlayers();
        } else if (panelName === "log") {
          loadSheetGrid("log", "Log", 50);
        } else if (panelName === "gameLedger") {
          loadSheetGrid("gameLedger", "Game Ledger", 50);
        } else if (panelName === "rewards") {
          loadSheetGrid("rewards", "Rewards", 50);
        } else if (panelName === "cashouts") {
          loadSheetGrid("cashouts", "Cashouts", 50);
        } else if (panelName === "stripe") {
          loadSheetGrid("stripe", "Stripe Ledger", 50);
        } else if (panelName === "paypal") {
          loadSheetGrid("paypal", "PayPal Ledger", 50);
        } else if (panelName === "blacklist") {
          loadSheetGrid("blacklist", "Blacklist", 50);
        } else if (panelName === "reports") {
          loadReports();
        } else if (panelName === "adminLog") {
          loadSheetGrid("adminLog", "Admin Log", 50);
        } else if (panelName === "dashboard") {
          loadDashboard();
        }
      }
    }

    // DASHBOARD
    async function loadDashboard() {
      if (!ciState.apiKey) return;
      setLoading(true, "Refreshing dashboard…");
      setStatus("Refreshing dashboard metrics…", false);

      try {
        const players = await fetchPlayersFromSheet(2000);
        const totalPlayers = players.length;
        let totalBalance = 0;
        let highRiskCount = 0;
        const topPlayers = [];
        const vipCounts = {};

        players.forEach(function (p) {
          const balance = Number(p.balance || 0);
          if (!isNaN(balance)) {
            totalBalance += balance;
            if (balance > 0) {
              topPlayers.push(p);
            }
          }
          const vip = (p.vipLevel || "").toString() || "None";
          vipCounts[vip] = (vipCounts[vip] || 0) + 1;
          if ((p.riskStatus || "").toLowerCase() === "high") highRiskCount++;
        });

        topPlayers.sort((a, b) => b.balance - a.balance);

        // Load Cashouts
        const cashRes = await adminGet("getSheet", { sheetName: "Cashouts", maxRows: 200 });
        if (!cashRes || !cashRes.ok) throw new Error("Failed to load Cashouts");
        const cashRows = cashRes.rows || [];

        // KPI UI Updates
        const elTotalPlayers = qs("#ci-kpi-total-players");
        const elTotalBalance = qs("#ci-kpi-total-balance");
        const elOpenCashouts = qs("#ci-kpi-open-cashouts");
        const elHighRisk = qs("#ci-kpi-high-risk");

        if (elTotalPlayers) elTotalPlayers.textContent = formatNumber(totalPlayers);
        if (elTotalBalance) elTotalBalance.textContent = formatChips(totalBalance);
        if (elHighRisk) elHighRisk.textContent = formatNumber(highRiskCount);
        if (elOpenCashouts) elOpenCashouts.textContent = formatNumber(cashRows.length);

        // VIP List
        const vipList = qs("#ci-dashboard-vip-list");
        if (vipList) {
          vipList.innerHTML = "";
          Object.keys(vipCounts).sort().forEach(vip => {
            const li = document.createElement("li");
            li.textContent = `${vip}: ${formatNumber(vipCounts[vip])} players`;
            vipList.appendChild(li);
          });
        }

        // Top Players Table
        const topBody = qs("#ci-dashboard-top-players-body");
        if (topBody) {
          topBody.innerHTML = "";
          const maxTop = Math.min(10, topPlayers.length);
          if (maxTop === 0) {
              topBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:var(--text-muted);">No positive balances.</td></tr>`;
          } else {
            for (let i = 0; i < maxTop; i++) {
              const p = topPlayers[i];
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${trimString(p.username || p.playerId, 24)}</td><td>${p.vipLevel || "—"}</td><td>${formatNumber(p.balance)}</td>`;
              topBody.appendChild(tr);
            }
          }
        }
        setStatus("Dashboard updated.", false);

      } catch (err) {
        setStatus("Dashboard error: " + err.message, true);
      } finally {
        setLoading(false);
      }
    }

    // --- GRID HANDLING (Smart Server-Side Search) ---

    function createSheetGrid(name, options) {
      return {
        name: name,
        headers: [],
        rows: [],
        rowNumbers: [],
        page: 1,
        pageSize: (options && options.pageSize) || 50,
        totalRows: 0,
        totalPages: 0,
        search: "" // Holds the current search term
      };
    }

    function initSheetGrids() {
      // Initialize state for each grid type
      const types = ["log", "gameLedger", "rewards", "cashouts", "stripe", "paypal", "blacklist", "reports", "adminLog"];
      types.forEach(t => {
        ciState.grids[t] = createSheetGrid(t, { pageSize: 50 });
      });
    }

    function getSheetNameForGrid(gridName) {
      switch (gridName) {
        case "log": return "Log";
        case "gameLedger": return "Game Ledger";
        case "rewards": return "Rewards";
        case "cashouts": return "Cashouts";
        case "stripe": return "Stripe Ledger";
        case "paypal": return "PayPal Ledger";
        case "blacklist": return "Blacklist";
        case "reports": return "Reports";
        case "adminLog": return "Admin Log";
        default: return "";
      }
    }

    // UPDATED: Now supports search and paging params sent to backend
    async function loadSheetGrid(gridName, sheetNameOverride, pageSizeOverride) {
      const grid = ciState.grids[gridName];
      if (!grid) return;
      const sheetName = sheetNameOverride || getSheetNameForGrid(gridName);
      if (!sheetName) return;

      if (pageSizeOverride) grid.pageSize = pageSizeOverride;

      setLoading(true, `Loading ${sheetName}...`);
      setStatus(`Fetching ${sheetName} data...`, false);

      try {
        // CALL BACKEND with smart params
        const res = await adminGet("getSheet", {
          sheetName: sheetName,
          page: grid.page,
          pageSize: grid.pageSize,
          search: grid.search // Pass the search string
        });

        if (!res || !res.ok) {
          throw new Error((res && res.error) || "Unknown error");
        }

        // Update State
        grid.headers = res.headers || [];
        grid.rows = res.rows || [];
        grid.rowNumbers = res.rowNumbers || [];
        grid.totalRows = res.totalRows || 0;
        grid.totalPages = res.totalPages || 0;
        grid.page = res.page || 1; // Sync with server clamped page

        renderGrid(gridName);
        setStatus(`${sheetName} updated. Found ${grid.totalRows} rows.`, false);
      } catch (err) {
        setStatus(`Failed to load ${sheetName}: ${err.message}`, true);
      } finally {
        setLoading(false);
      }
    }

    function renderGrid(gridName) {
      const grid = ciState.grids[gridName];
      if (!grid) return;

      const headRow = qs(`[data-grid-head="${gridName}"]`);
      const bodyEl = qs(`[data-grid-body="${gridName}"]`);
      const pageInfoEl = qs(`[data-grid-page-info="${gridName}"]`);

      if (!headRow || !bodyEl || !pageInfoEl) return;

      // Headers
      headRow.innerHTML = "";
      grid.headers.forEach((h, idx) => {
        const th = document.createElement("th");
        th.textContent = h || "";
        headRow.appendChild(th);
      });

      // Body (No slicing needed, server sent exact page)
      bodyEl.innerHTML = "";
      if (!grid.rows || grid.rows.length === 0) {
        bodyEl.innerHTML = `<tr><td colspan="${grid.headers.length}" style="text-align:center;color:var(--text-muted);">No results found.</td></tr>`;
      } else {
        grid.rows.forEach((row, i) => {
          const tr = document.createElement("tr");
          // Use real row number from server if available
          const realIdx = grid.rowNumbers[i] || i;
          tr.dataset.rowIndex = String(i); 
          tr.dataset.sheetRow = String(realIdx);

          // Selection logic for Cashouts
          if (gridName === "cashouts" && ciState.selectedCashoutsRowIdx === i) {
             tr.classList.add("ci-table-row-selected");
          }

          row.forEach((cell, cIdx) => {
            const td = document.createElement("td");
            // Rewards Status Button Logic
            if (gridName === "rewards" && String(grid.headers[cIdx]).toLowerCase() === "status") {
               const btn = document.createElement("button");
               btn.className = "ci-link-button";
               btn.textContent = cell || "(set)";
               btn.onclick = () => {
                 const newVal = prompt("Update Status:", cell);
                 if(newVal) updateRewardsStatus(i, newVal);
               };
               td.appendChild(btn);
            } else {
               td.textContent = cell == null ? "" : cell;
            }
            tr.appendChild(td);
          });
          bodyEl.appendChild(tr);
        });
      }

      // Footer Info
      pageInfoEl.textContent = `Page ${grid.page} of ${grid.totalPages || 1} • ${formatNumber(grid.totalRows)} rows found`;
    }

    function attachGridDomHandlers() {
      // SEARCH HANDLER (Debounced)
      qsa("[data-grid-search]").forEach(input => {
        const gridName = input.getAttribute("data-grid-search");
        input.addEventListener("input", function () {
          const grid = ciState.grids[gridName];
          if (!grid) return;
          
          grid.search = input.value.trim(); // Update search state
          grid.page = 1; // Reset to page 1 on new search

          // Debounce network call
          if (ciState.searchTimer) clearTimeout(ciState.searchTimer);
          ciState.searchTimer = setTimeout(() => {
            loadSheetGrid(gridName); 
          }, 500); // 500ms delay
        });
      });

      // PAGE SIZE
      qsa("[data-grid-page-size]").forEach(sel => {
        const gridName = sel.getAttribute("data-grid-page-size");
        sel.addEventListener("change", function () {
          const grid = ciState.grids[gridName];
          if (!grid) return;
          grid.pageSize = Number(sel.value);
          grid.page = 1;
          loadSheetGrid(gridName);
        });
      });

      // PREV BUTTON
      qsa("[data-grid-prev]").forEach(btn => {
        const gridName = btn.getAttribute("data-grid-prev");
        btn.addEventListener("click", function () {
          const grid = ciState.grids[gridName];
          if (!grid || grid.page <= 1) return;
          grid.page--;
          loadSheetGrid(gridName);
        });
      });

      // NEXT BUTTON
      qsa("[data-grid-next]").forEach(btn => {
        const gridName = btn.getAttribute("data-grid-next");
        btn.addEventListener("click", function () {
          const grid = ciState.grids[gridName];
          if (!grid || grid.page >= grid.totalPages) return;
          grid.page++;
          loadSheetGrid(gridName);
        });
      });

      // REFRESH BUTTON
      qsa("[data-grid-refresh]").forEach(btn => {
        const gridName = btn.getAttribute("data-grid-refresh");
        btn.addEventListener("click", function () {
          loadSheetGrid(gridName);
        });
      });

      // PRINT
      qsa("[data-grid-print]").forEach(btn => {
        btn.addEventListener("click", () => window.print());
      });

      // Cashouts Row Click
      const cashBody = qs('[data-grid-body="cashouts"]');
      if (cashBody) {
        cashBody.addEventListener("click", (e) => {
          const tr = e.target.closest("tr");
          if(!tr) return;
          const idx = Number(tr.dataset.rowIndex);
          selectCashoutsRow(idx);
        });
      }

      // Cashout Status Save
      const cashSave = qs("#ci-cashouts-save-status");
      if(cashSave) {
        cashSave.addEventListener("click", () => {
          const sel = qs("#ci-cashouts-status-select");
          if(sel) updateCashoutsStatus(sel.value);
        });
      }
    }

    // ACTIONS (Rewards/Cashouts Updates)
    async function updateRewardsStatus(rowIdx, newStatus) {
       const grid = ciState.grids.rewards;
       // Logic to call updateCellStatus via adminGet...
       // Simplified for brevity, follows pattern of backend call
       const rowNumber = grid.rowNumbers[rowIdx];
       if(!rowNumber) return;
       setLoading(true, "Updating...");
       await adminGet("updateCellStatus", {
         sheetName: "Rewards",
         rowNumbers: String(rowNumber),
         status: newStatus
       });
       loadSheetGrid("rewards");
       setLoading(false);
    }

    // Cashouts Selection UI
    function selectCashoutsRow(idx) {
       ciState.selectedCashoutsRowIdx = idx;
       renderGrid("cashouts");
       const grid = ciState.grids.cashouts;
       const row = grid.rows[idx];
       const headers = grid.headers;
       // Find Status Col
       let statusVal = "Pending";
       const sIdx = headers.findIndex(h => h.toLowerCase() === "status");
       if(sIdx > -1 && row[sIdx]) statusVal = row[sIdx];
       
       const lbl = qs("#ci-cashouts-current-status");
       const sel = qs("#ci-cashouts-status-select");
       const editor = qs("#ci-cashouts-status-editor");
       
       if(lbl) lbl.textContent = statusVal;
       if(sel) sel.value = statusVal;
       if(editor) editor.style.display = "block";
    }

    async function updateCashoutsStatus(newStatus) {
       const grid = ciState.grids.cashouts;
       const idx = ciState.selectedCashoutsRowIdx;
       if(idx == null) return;
       const rowNumber = grid.rowNumbers[idx];
       
       setLoading(true, "Saving...");
       await adminGet("updateCellStatus", {
         sheetName: "Cashouts",
         rowNumbers: String(rowNumber),
         status: newStatus
       });
       loadSheetGrid("cashouts");
       setLoading(false);
    }

    // REPORTS
    async function loadReports() {
      await loadSheetGrid("reports", "Reports", 500);
      updateReportsKpis();
    }

    function updateReportsKpis() {
      // Logic to parse latest report row and update KPI cards
      const grid = ciState.grids.reports;
      if(!grid.rows.length) return;
      const row = grid.rows[0]; // Newest first
      // Map indices based on headers... 
      // (Simplified: assuming column order matches backend generation)
      if(qs("#ci-reports-kpi-total-balance")) qs("#ci-reports-kpi-total-balance").textContent = formatChips(row[1]);
      if(qs("#ci-reports-kpi-total-purchased")) qs("#ci-reports-kpi-total-purchased").textContent = formatNumber(row[2]);
      if(qs("#ci-reports-kpi-total-cashed")) qs("#ci-reports-kpi-total-cashed").textContent = formatNumber(row[3]);
      if(qs("#ci-reports-kpi-house-ggr")) qs("#ci-reports-kpi-house-ggr").textContent = formatChips(row[9]);
    }

    async function rebuildAndLoadReports() {
      setLoading(true, "Rebuilding...");
      await adminGet("refreshReports", {});
      await loadReports();
      setLoading(false);
    }

    // INIT
    function initAdminPortal() {
      const label = qs("#ci-admin-webapp-label");
      if (label) label.textContent = "Configured";

      const loginForm = qs("#ci-admin-login-form");
      const loginReset = qs("#ci-admin-login-reset");
      if (loginForm) loginForm.addEventListener("submit", handleAdminLogin);
      if (loginReset) loginReset.addEventListener("click", resetLoginForm);

      qsa(".ci-admin-tab").forEach(function (btn) {
        btn.addEventListener("click", function () {
          activateTab(btn.getAttribute("data-tab"));
        });
      });

      initSheetGrids();
      attachGridDomHandlers();
      initPlayersDomHandlers();

      const dashRef = qs("#ci-dashboard-refresh-btn");
      if (dashRef) dashRef.addEventListener("click", loadDashboard);
      
      const repRef = qs("#ci-reports-refresh-btn");
      if (repRef) repRef.addEventListener("click", rebuildAndLoadReports);

      setStatus("Enter your admin credentials to unlock the portal.", false);
      setOnlineBadge(false);
    }

    document.addEventListener("DOMContentLoaded", initAdminPortal);
  </script>
</body>
</html>
